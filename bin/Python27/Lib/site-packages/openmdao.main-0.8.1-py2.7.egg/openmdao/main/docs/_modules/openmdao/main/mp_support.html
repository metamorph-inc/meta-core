
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>openmdao.main.mp_support &mdash; OpenMDAO Documentation</title>
    
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.8.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="OpenMDAO Documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
  <li><a href="http://openmdao.org">OpenMDAO Home</a> &raquo;</li>
  
        <li><a href="../../../index.html">OpenMDAO Documentation v0.8.1</a> &raquo;</li>

          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for openmdao.main.mp_support</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module defines modified versions of some classes and functions defined in</span>
<span class="sd">:mod:`multiprocessing.managers` to support OpenMDAO distributed simulations.</span>

<span class="sd">Channel communication can be secured by setting `authkey` to &#39;PublicKey&#39;.</span>
<span class="sd">When `authkey` is &#39;PublicKey&#39;, an additional session establishment protocol</span>
<span class="sd">is used between the Proxy and Server:</span>

<span class="sd">1. Proxy sends session request containing the proxy&#39;s public key, encrypted with</span>
<span class="sd">   the server&#39;s public key (obtained when told what server to connect to).</span>

<span class="sd">2. Server responds with random session key, encrypted with proxy&#39;s public key.</span>

<span class="sd">3. Subsequent communication is encrypted with the session key (which presumably</span>
<span class="sd">   is quicker than public/private key encryption).</span>

<span class="sd">If `authkey` is not &#39;PublicKey&#39;, then the above session protocol is not used,</span>
<span class="sd">and channel data is in the clear.</span>

<span class="sd">Public methods of an object are determined by a role-based access control</span>
<span class="sd">attribute associated with the method. The server will verify that the current</span>
<span class="sd">role is allowed access. The current role is determined by an</span>
<span class="sd">:class:`AccessController` based on a :class:`Credentials` object received from</span>
<span class="sd">the proxy.</span>

<span class="sd">Assuming the credentials check passes, the server will set its credentials</span>
<span class="sd">to those specified by the :class:`AccessController` during the execution of the</span>
<span class="sd">method.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c"># Unfortunately, there&#39;s a lot of multiprocessing package code duplication here.</span>
<span class="c"># And a lot of this should be done at a lower layer. But then we&#39;d be</span>
<span class="c"># duplicating connection.py code as well as (more) managers.py code. Another</span>
<span class="c"># alternative is to just use our own conection.py and managers.py (and whatever</span>
<span class="c"># else might bleed in) as our private multiprocessing package.</span>
<span class="c"># No obvious &#39;best&#39; alternative.</span>

<span class="kn">import</span> <span class="nn">errno</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">traceback</span>

<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">current_process</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">util</span>
<span class="kn">from</span> <span class="nn">multiprocessing.forking</span> <span class="kn">import</span> <span class="n">Popen</span>
<span class="kn">from</span> <span class="nn">multiprocessing.managers</span> <span class="kn">import</span> <span class="n">BaseManager</span><span class="p">,</span> <span class="n">BaseProxy</span><span class="p">,</span> <span class="n">RebuildProxy</span><span class="p">,</span> \
                                     <span class="n">Server</span><span class="p">,</span> <span class="n">State</span><span class="p">,</span> <span class="n">Token</span><span class="p">,</span> <span class="n">convert_to_error</span><span class="p">,</span> \
                                     <span class="n">dispatch</span>

<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&#39;win32&#39;</span><span class="p">:</span>  <span class="c">#pragma no cover</span>
    <span class="kn">from</span> <span class="nn">_multiprocessing</span> <span class="kn">import</span> <span class="n">win32</span>

<span class="kn">from</span> <span class="nn">traits.trait_handlers</span> <span class="kn">import</span> <span class="n">TraitDictObject</span>

<span class="kn">from</span> <span class="nn">openmdao.main.interfaces</span> <span class="kn">import</span> <span class="n">obj_has_interface</span>
<span class="kn">from</span> <span class="nn">openmdao.main.mp_util</span> <span class="kn">import</span> <span class="n">decrypt</span><span class="p">,</span> <span class="n">encrypt</span><span class="p">,</span> <span class="n">is_legal_connection</span><span class="p">,</span> \
                                  <span class="n">keytype</span><span class="p">,</span> <span class="n">make_typeid</span><span class="p">,</span> <span class="n">public_methods</span><span class="p">,</span> \
                                  <span class="n">tunnel_address</span><span class="p">,</span> <span class="n">SPECIALS</span>
<span class="kn">from</span> <span class="nn">openmdao.main.rbac</span> <span class="kn">import</span> <span class="n">AccessController</span><span class="p">,</span> <span class="n">RoleError</span><span class="p">,</span> <span class="n">check_role</span><span class="p">,</span> \
                               <span class="n">need_proxy</span><span class="p">,</span> <span class="n">Credentials</span><span class="p">,</span> \
                               <span class="n">get_credentials</span><span class="p">,</span> <span class="n">set_credentials</span>

<span class="kn">from</span> <span class="nn">openmdao.util.log</span> <span class="kn">import</span> <span class="n">install_remote_handler</span><span class="p">,</span> <span class="n">remove_remote_handlers</span><span class="p">,</span> \
                              <span class="n">logging_port</span><span class="p">,</span> <span class="n">LOG_DEBUG2</span><span class="p">,</span> <span class="n">LOG_DEBUG3</span>

<span class="kn">from</span> <span class="nn">openmdao.util.publickey</span> <span class="kn">import</span> <span class="n">decode_public_key</span><span class="p">,</span> <span class="n">encode_public_key</span><span class="p">,</span> \
                                    <span class="n">get_key_pair</span><span class="p">,</span> <span class="n">HAVE_PYWIN32</span><span class="p">,</span> \
                                    <span class="n">pk_encrypt</span><span class="p">,</span> <span class="n">pk_decrypt</span>

<span class="c"># Classes which require proxying (used by default AccessController)</span>
<span class="c"># Used to break import loop between this and openmdao.main.container.</span>
<span class="n">CLASSES_TO_PROXY</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c"># Cache of proxies created by _make_proxy_type().</span>
<span class="n">_PROXY_CACHE</span> <span class="o">=</span> <span class="p">{}</span>


<div class="viewcode-block" id="is_instance"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.mp_support.is_instance">[docs]</a><span class="k">def</span> <span class="nf">is_instance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">type_info</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :func:`isinstance` replacement for when `obj` might be a proxy.</span>

<span class="sd">    obj: object</span>
<span class="sd">        Object to be tested.</span>

<span class="sd">    type_info: class or tuple of classes</span>
<span class="sd">        Class(es) to be tested against.</span>

<span class="sd">    Returns True if `obj` is an instance of `type_info` or the object `obj`</span>
<span class="sd">    refers to is an instance of `type_info`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">OpenMDAO_Proxy</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">type_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">type_info</span> <span class="o">=</span> <span class="p">(</span><span class="n">type_info</span><span class="p">,)</span>
        <span class="k">for</span> <span class="n">typ</span> <span class="ow">in</span> <span class="n">type_info</span><span class="p">:</span>
            <span class="n">typename</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">typ</span><span class="o">.</span><span class="n">__module__</span><span class="p">,</span> <span class="n">typ</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">__is_instance__</span><span class="p">(</span><span class="n">typename</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">type_info</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="has_interface"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.mp_support.has_interface">[docs]</a><span class="k">def</span> <span class="nf">has_interface</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="o">*</span><span class="n">ifaces</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :func:`obj_has_interface` replacement for when `obj` might be a proxy.</span>

<span class="sd">    obj: object</span>
<span class="sd">        Object to be tested.</span>

<span class="sd">    ifaces: list[Interface]</span>
<span class="sd">        Interfaces to be tested against.</span>

<span class="sd">    Returns True if `obj` or the object `obj` refers to supports at least one</span>
<span class="sd">    :class:`Interface` in `ifaces`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">OpenMDAO_Proxy</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">typ</span> <span class="ow">in</span> <span class="n">ifaces</span><span class="p">:</span>
            <span class="n">typename</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">typ</span><span class="o">.</span><span class="n">__module__</span><span class="p">,</span> <span class="n">typ</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">__has_interface__</span><span class="p">(</span><span class="n">typename</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">obj_has_interface</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="o">*</span><span class="n">ifaces</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="OpenMDAO_Server"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.mp_support.OpenMDAO_Server">[docs]</a><span class="k">class</span> <span class="nc">OpenMDAO_Server</span><span class="p">(</span><span class="n">Server</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A :class:`Server` that supports dynamic proxy generation and credential</span>
<span class="sd">    checking.</span>

<span class="sd">    registry: dict</span>
<span class="sd">        Manager&#39;s proxy registry.</span>

<span class="sd">    address: tuple or string</span>
<span class="sd">        A :mod:`multiprocessing` address specifying an Internet address or</span>
<span class="sd">        a pipe.</span>

<span class="sd">    authkey: string</span>
<span class="sd">        Authorization key. Inherited from the current :class:`Process`</span>
<span class="sd">        object if not specified.</span>

<span class="sd">    serializer: string</span>
<span class="sd">        Which serialization method to use.</span>

<span class="sd">    name: string</span>
<span class="sd">        Name for server, used in log files, etc.</span>

<span class="sd">    allowed_hosts: list(string)</span>
<span class="sd">        Host address patterns to check against.</span>
<span class="sd">        Optional if `allowed_users` is specified.</span>

<span class="sd">    allowed_users: dict</span>
<span class="sd">        Dictionary of users and corresponding public keys allowed access.</span>
<span class="sd">        If None, any user may access. If empty, no user may access.</span>
<span class="sd">        The host portions of user strings are used for address patterns.</span>

<span class="sd">    allow_tunneling: bool</span>
<span class="sd">        If True, allow connections from the local host, even if not listed</span>
<span class="sd">        otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">registry</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">authkey</span><span class="p">,</span> <span class="n">serializer</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">allowed_hosts</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">allowed_users</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">allow_tunneling</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">OpenMDAO_Server</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">registry</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">authkey</span><span class="p">,</span>
                                              <span class="n">serializer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="ow">or</span> <span class="p">(</span><span class="s">&#39;OMS_</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;OpenMDAO_Server process </span><span class="si">%d</span><span class="s"> started, </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span>
                          <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span> <span class="n">keytype</span><span class="p">(</span><span class="n">authkey</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_allowed_users</span> <span class="o">=</span> <span class="n">allowed_users</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allowed_users</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">hosts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">user_host</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allowed_users</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">user</span><span class="p">,</span> <span class="n">host</span> <span class="o">=</span> <span class="n">user_host</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;@&#39;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ip_addr</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostbyname</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">gaierror</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;No address for </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">host</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">hosts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ip_addr</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">host</span> <span class="o">==</span> <span class="n">socket</span><span class="o">.</span><span class="n">getfqdn</span><span class="p">()</span> <span class="ow">or</span> <span class="n">host</span> <span class="o">==</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">():</span>
                    <span class="n">hosts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;127.0.0.1&#39;</span><span class="p">)</span>  <span class="c"># localhost</span>
            <span class="k">if</span> <span class="n">allowed_hosts</span><span class="p">:</span>
                <span class="n">hosts</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">(</span><span class="n">allowed_hosts</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_allowed_hosts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">hosts</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_allowed_hosts</span> <span class="o">=</span> <span class="n">allowed_hosts</span> <span class="ow">or</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_allow_tunneling</span> <span class="o">=</span> <span class="n">allow_tunneling</span>
        <span class="k">if</span> <span class="n">allow_tunneling</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_allowed_hosts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;127.0.0.1&#39;</span><span class="p">)</span>  <span class="c"># localhost</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_allowed_hosts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">gethostbyname</span><span class="p">(</span><span class="n">address</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allowed_users</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;    allowed_users: ANY&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;    allowed_users: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span>
                              <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_allowed_users</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allowed_hosts</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;    allowed_hosts: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span>
                              <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_allowed_hosts</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;    allowed_hosts: ANY&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_authkey</span> <span class="o">=</span> <span class="n">authkey</span>
        <span class="k">if</span> <span class="n">authkey</span> <span class="o">==</span> <span class="s">&#39;PublicKey&#39;</span><span class="p">:</span>
            <span class="c"># While we may be &#39;owned&#39; by some remote user, use default</span>
            <span class="c"># credentials for getting our key pair. This avoids generation</span>
            <span class="c"># overhead and also issues with propagating our public key</span>
            <span class="c"># back through a proxy.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_key_pair</span> <span class="o">=</span> <span class="n">get_key_pair</span><span class="p">(</span><span class="n">Credentials</span><span class="o">.</span><span class="n">user_host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_key_pair</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_id_to_controller</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_access_controller</span> <span class="o">=</span> <span class="n">AccessController</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">cls</span> <span class="ow">in</span> <span class="n">CLASSES_TO_PROXY</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_access_controller</span><span class="o">.</span><span class="n">class_proxy_required</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_address_type</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">address_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>

    <span class="nd">@property</span>
<div class="viewcode-block" id="OpenMDAO_Server.public_key"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.mp_support.OpenMDAO_Server.public_key">[docs]</a>    <span class="k">def</span> <span class="nf">public_key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Public key for session establishment. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_authkey</span> <span class="o">==</span> <span class="s">&#39;PublicKey&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key_pair</span><span class="o">.</span><span class="n">publickey</span><span class="p">()</span>
        <span class="c"># Just being defensive.</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c">#pragma no cover</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;No public key available&#39;</span><span class="p">)</span>

    <span class="c"># This happens on the remote server side and we&#39;ll check when connecting.</span></div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="OpenMDAO_Server.public_key_text"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.mp_support.OpenMDAO_Server.public_key_text">[docs]</a>    <span class="k">def</span> <span class="nf">public_key_text</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c">#pragma no cover</span>
        <span class="sd">&quot;&quot;&quot; Text representation of public key. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_authkey</span> <span class="o">==</span> <span class="s">&#39;PublicKey&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">encode_public_key</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">public_key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;&#39;</span>
</div>
<div class="viewcode-block" id="OpenMDAO_Server.serve_forever"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.mp_support.OpenMDAO_Server.serve_forever">[docs]</a>    <span class="k">def</span> <span class="nf">serve_forever</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the server forever.</span>
<span class="sd">        This version supports host connection filtering.</span>
<span class="sd">        Connection filtering allows for PublicKey servers which aren&#39;t</span>
<span class="sd">        accessible by just any host.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">current_process</span><span class="p">()</span><span class="o">.</span><span class="n">_manager_server</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">listener</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
                        <span class="c"># Comment-out the line above and use this equivalent</span>
                        <span class="c"># to debug connectivity issues.</span>
                        <span class="c">#conn = self.listener._listener.accept()</span>
                        <span class="c">#self._logger.critical(&#39;connection attempt from %r&#39;,</span>
                        <span class="c">#                      self.listener.last_accepted)</span>
                        <span class="c">#if self.listener._authkey:</span>
                        <span class="c">#    connection.deliver_challenge(conn, self.listener._authkey)</span>
                        <span class="c">#    connection.answer_challenge(conn, self.listener._authkey)</span>

                    <span class="c"># Hard to cause this to happen.</span>
                    <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">IOError</span><span class="p">):</span>  <span class="c">#pragma no cover</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">continue</span>

                    <span class="n">address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">listener</span><span class="o">.</span><span class="n">last_accepted</span>
                    <span class="k">if</span> <span class="n">address</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_legal_connection</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allowed_hosts</span><span class="p">,</span>
                                                   <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">):</span>
                            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                            <span class="k">continue</span>

                    <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">handle_request</span><span class="p">,</span>
                                         <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">conn</span><span class="p">,))</span>
                    <span class="n">t</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                    <span class="c"># Don&#39;t want to cause this to happen.</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>  <span class="c">#pragma no cover</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Can&#39;t start server thread: </span><span class="si">%r</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>
                        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                        <span class="k">continue</span>
            <span class="c"># Don&#39;t want to cause this to happen.</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">KeyboardInterrupt</span><span class="p">,</span> <span class="ne">SystemExit</span><span class="p">):</span>  <span class="c">#pragma no cover</span>
                <span class="k">pass</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">=</span> <span class="mi">999</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">listener</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;Exception closing listener: </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="OpenMDAO_Server.handle_request"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.mp_support.OpenMDAO_Server.handle_request">[docs]</a>    <span class="k">def</span> <span class="nf">handle_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle a new connection.</span>

<span class="sd">        conn: socket or pipe</span>
<span class="sd">            Connection to process.</span>

<span class="sd">        This version filters host connections and avoids getting upset if it</span>
<span class="sd">        can&#39;t deliver a challenge. This is to deal with immediately closed</span>
<span class="sd">        connections caused by :meth:`manager_is_alive` which are used to avoid</span>
<span class="sd">        getting hung trying to connect to a manager which is no longer there.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">funcname</span> <span class="o">=</span> <span class="n">result</span> <span class="o">=</span> <span class="n">request</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">deliver_challenge</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">authkey</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">EOFError</span><span class="p">,</span> <span class="ne">IOError</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span>
        <span class="c"># Hard to cause this to happen. It rarely happens, and then at shutdown.</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>  <span class="c">#pragma no cover</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;#TRACEBACK&#39;</span><span class="p">,</span> <span class="s">&#39;Exception delivering challenge: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">exc</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">util</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Failure to send message: </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
            <span class="n">util</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39; ... request was </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
            <span class="n">util</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39; ... exception was </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">answer_challenge</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">authkey</span><span class="p">)</span>
            <span class="n">request</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
            <span class="n">ignore</span><span class="p">,</span> <span class="n">funcname</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwds</span> <span class="o">=</span> <span class="n">request</span>
            <span class="k">assert</span> <span class="n">funcname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">public</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%r</span><span class="s"> unrecognized&#39;</span> <span class="o">%</span> <span class="n">funcname</span>
            <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">funcname</span><span class="p">)</span>
        <span class="c"># Hard to cause this to happen. It rarely happens, and then at shutdown.</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>  <span class="c">#pragma no cover</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;#TRACEBACK&#39;</span><span class="p">,</span> <span class="s">&#39;Exception answering challenge: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">exc</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
            <span class="c"># Hard to cause this to happen. It rarely happens, and then at shutdown.</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>  <span class="c">#pragma no cover</span>
                <span class="k">try</span><span class="p">:</span>  <span class="c"># Sometimes at shutdown &#39;traceback&#39; is None!?</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;#TRACEBACK&#39;</span><span class="p">,</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;#TRACEBACK&#39;</span><span class="p">,</span>
                           <span class="s">&#39;Exception from </span><span class="si">%r</span><span class="s">: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">funcname</span><span class="p">,</span> <span class="n">exc</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;#RETURN&#39;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="c"># Hard to cause this to happen. It rarely happens, and then at shutdown.</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>  <span class="c">#pragma no cover</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">((</span><span class="s">&#39;#TRACEBACK&#39;</span><span class="p">,</span> <span class="s">&#39;Exception sending reply: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">exc</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">util</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Failure to send message: </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
            <span class="n">util</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39; ... request was </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
            <span class="n">util</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39; ... exception was </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>

        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="OpenMDAO_Server.serve_client"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.mp_support.OpenMDAO_Server.serve_client">[docs]</a>    <span class="k">def</span> <span class="nf">serve_client</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle requests from the proxies in a particular process/thread.</span>

<span class="sd">        conn: socket or pipe</span>
<span class="sd">            Connection to process.</span>

<span class="sd">        This version supports dynamic proxy generation and credential checking.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">LOG_DEBUG2</span><span class="p">,</span> <span class="s">&#39;starting server thread to service </span><span class="si">%r</span><span class="s">, </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span>
                         <span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">keytype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_authkey</span><span class="p">))</span>
        <span class="n">recv</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">recv</span>
        <span class="n">send</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">send</span>
        <span class="n">id_to_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_to_obj</span>
        <span class="n">id_to_controller</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id_to_controller</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_authkey</span> <span class="o">==</span> <span class="s">&#39;PublicKey&#39;</span><span class="p">:</span>
            <span class="n">client_key</span><span class="p">,</span> <span class="n">session_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_session</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">client_key</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="n">session_key</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">:</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">ident</span> <span class="o">=</span> <span class="n">methodname</span> <span class="o">=</span> <span class="n">args</span> <span class="o">=</span> <span class="n">kwds</span> <span class="o">=</span> <span class="n">credentials</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">exposed</span> <span class="o">=</span> <span class="n">gettypeid</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">recv</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">request</span> <span class="o">=</span> <span class="n">decrypt</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">session_key</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Can&#39;t decrypt/unpack request. This could be the&quot;</span> \
                          <span class="s">&quot; result of referring to a dead server.&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                <span class="n">ident</span><span class="p">,</span> <span class="n">methodname</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwds</span><span class="p">,</span> <span class="n">credentials</span> <span class="o">=</span> <span class="n">request</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">LOG_DEBUG3</span><span class="p">,</span> <span class="s">&#39;request </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">ident</span><span class="p">,</span> <span class="n">methodname</span><span class="p">)</span>
<span class="c">#                self._logger.log(LOG_DEBUG3, &#39;credentials %s&#39;, credentials)</span>
<span class="c">#                self._logger.log(LOG_DEBUG3, &#39;id_to_obj:\n%s&#39;,</span>
<span class="c">#                                 self.debug_info(conn))</span>

                <span class="c"># Decode and verify valid credentials.</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">credentials</span> <span class="o">=</span> <span class="n">Credentials</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">credentials</span><span class="p">,</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">_allowed_users</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">exc</span><span class="p">)</span>
                    <span class="k">raise</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">obj</span><span class="p">,</span> <span class="n">exposed</span><span class="p">,</span> <span class="n">gettypeid</span> <span class="o">=</span> <span class="n">id_to_obj</span><span class="p">[</span><span class="n">ident</span><span class="p">]</span>
                <span class="c"># Hard to cause this to happen.</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>  <span class="c">#pragma no cover</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;No object for ident </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">ident</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%r</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">msg</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">methodname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exposed</span><span class="p">:</span>
                    <span class="c"># Try to raise with a useful error message.</span>
                    <span class="k">if</span> <span class="n">methodname</span> <span class="o">==</span> <span class="s">&#39;__getattr__&#39;</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                                  <span class="s">&#39;attribute </span><span class="si">%r</span><span class="s"> of </span><span class="si">%r</span><span class="s"> object does not exist&#39;</span>
                                  <span class="o">%</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)))</span>
                        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">ismethod</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
                            <span class="n">methodname</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                                  <span class="s">&#39;attribute </span><span class="si">%r</span><span class="s"> of </span><span class="si">%r</span><span class="s"> is not accessible&#39;</span>
                                  <span class="o">%</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)))</span>
                    <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                                  <span class="s">&#39;method </span><span class="si">%r</span><span class="s"> of </span><span class="si">%r</span><span class="s"> object is not in exposed=</span><span class="si">%r</span><span class="s">&#39;</span>
                                  <span class="o">%</span> <span class="p">(</span><span class="n">methodname</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span> <span class="n">exposed</span><span class="p">))</span>

                <span class="c"># Set correct credentials for function lookup.</span>
                <span class="n">set_credentials</span><span class="p">(</span><span class="n">credentials</span><span class="p">)</span>
                <span class="n">function</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">methodname</span><span class="p">)</span>

                <span class="c"># Proxy pass-through only happens remotely.</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">BaseProxy</span><span class="p">):</span>  <span class="c">#pragma no cover</span>
                    <span class="n">role</span> <span class="o">=</span> <span class="bp">None</span>
                    <span class="n">access_controller</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c"># Check for allowed access.</span>
                    <span class="n">role</span><span class="p">,</span> <span class="n">credentials</span><span class="p">,</span> <span class="n">access_controller</span> <span class="o">=</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">_check_access</span><span class="p">(</span><span class="n">ident</span><span class="p">,</span> <span class="n">methodname</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span>
                                           <span class="n">credentials</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">methodname</span> <span class="o">!=</span> <span class="s">&#39;echo&#39;</span><span class="p">:</span>
                    <span class="c"># &#39;echo&#39; is used for performance tests, keepalives, etc.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">LOG_DEBUG2</span><span class="p">,</span> <span class="s">&quot;Invoke </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span><span class="p">,</span>
                                       <span class="n">methodname</span><span class="p">,</span> <span class="n">role</span><span class="p">,</span> <span class="n">credentials</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">LOG_DEBUG3</span><span class="p">,</span> <span class="s">&#39;       </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwds</span><span class="p">)</span>

                <span class="c"># Invoke function.</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">res</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">LOG_DEBUG3</span><span class="p">,</span> <span class="s">&#39;       res </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">BaseProxy</span><span class="p">)</span> <span class="ow">and</span> \
                           <span class="n">methodname</span> <span class="o">==</span> <span class="s">&#39;__getattribute__&#39;</span><span class="p">:</span>
                            <span class="c"># Avoid an extra round-trip.</span>
                            <span class="n">res</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">__getattr__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> failed:&#39;</span><span class="p">,</span>
                                           <span class="n">methodname</span><span class="p">,</span> <span class="n">role</span><span class="p">,</span> <span class="n">credentials</span><span class="p">)</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;#ERROR&#39;</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_form_reply</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">ident</span><span class="p">,</span> <span class="n">methodname</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span>
                                           <span class="n">args</span><span class="p">,</span> <span class="n">access_controller</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="c"># Just being defensive, this should never happen.</span>
                <span class="k">if</span> <span class="n">methodname</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>  <span class="c">#pragma no cover</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;#TRACEBACK&#39;</span><span class="p">,</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">orig_traceback</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">fallback_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fallback_mapping</span><span class="p">[</span><span class="n">methodname</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">LOG_DEBUG2</span><span class="p">,</span> <span class="s">&#39;Fallback </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">methodname</span><span class="p">)</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">fallback_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">ident</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span>
                                               <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;#RETURN&#39;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;#TRACEBACK&#39;</span><span class="p">,</span> <span class="n">orig_traceback</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">EOFError</span><span class="p">:</span>
                <span class="n">util</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;got EOF -- exiting thread serving </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span>
                           <span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="c"># Just being defensive, this should never happen.</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c">#pragma no cover</span>
                <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;serve_client exception, method </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span>
                                   <span class="n">methodname</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;#TRACEBACK&#39;</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">send</span><span class="p">(</span><span class="n">encrypt</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">session_key</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">send</span><span class="p">(</span><span class="n">encrypt</span><span class="p">((</span><span class="s">&#39;#UNSERIALIZABLE&#39;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">msg</span><span class="p">)),</span> <span class="n">session_key</span><span class="p">))</span>
            <span class="c"># Just being defensive, this should never happen.</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span> <span class="c">#pragma no cover</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;exception in thread serving </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span>
                                   <span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39; ... message was </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39; ... exception was </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_init_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Receive client public key, send session key. &quot;&quot;&quot;</span>
        <span class="c"># Hard to cause exceptions to happen where we&#39;ll see them.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">client_data</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>  <span class="c">#pragma no cover</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Can&#39;t receive client data: </span><span class="si">%r</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="n">client_version</span> <span class="o">=</span> <span class="n">client_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">client_version</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>  <span class="c">#pragma no cover</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Expected client protocol version 1, got </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">client_version</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">n</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">encrypted</span> <span class="o">=</span> <span class="n">client_data</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">if</span> <span class="n">e</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key_pair</span><span class="o">.</span><span class="n">e</span> <span class="ow">or</span> <span class="n">n</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key_pair</span><span class="o">.</span><span class="n">n</span><span class="p">:</span>  <span class="c">#pragma no cover</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Server key mismatch&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">pk_decrypt</span><span class="p">(</span><span class="n">encrypted</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key_pair</span><span class="p">)</span>
            <span class="n">client_key</span> <span class="o">=</span> <span class="n">decode_public_key</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>  <span class="c">#pragma no cover</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Can&#39;t recreate client key: </span><span class="si">%r</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="n">server_version</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">session_key</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">conn</span><span class="p">)))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">client_key</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">session_key</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">((</span><span class="n">server_version</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>  <span class="c">#pragma no cover</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Can&#39;t send session key: </span><span class="si">%r</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">client_key</span><span class="p">,</span> <span class="n">session_key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_access</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ident</span><span class="p">,</span> <span class="n">methodname</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">credentials</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Check for valid access, return (role, credentials, controller). &quot;&quot;&quot;</span>
        <span class="n">obj</span><span class="p">,</span> <span class="n">exposed</span><span class="p">,</span> <span class="n">gettypeid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_to_obj</span><span class="p">[</span><span class="n">ident</span><span class="p">]</span>

        <span class="c"># Get access controller for obj.</span>
        <span class="n">access_controller</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id_to_controller</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ident</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">access_controller</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">get_access_controller</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s">&#39;get_access_controller&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">access_controller</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_access_controller</span>
            <span class="c"># Only happens on remote protected object.</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c">#pragma no cover</span>
                <span class="k">if</span> <span class="n">get_access_controller</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">access_controller</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_access_controller</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">access_controller</span> <span class="o">=</span> <span class="n">get_access_controller</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_id_to_controller</span><span class="p">[</span><span class="n">ident</span><span class="p">]</span> <span class="o">=</span> <span class="n">access_controller</span>

        <span class="c"># Get role based on credentials.</span>
        <span class="n">role</span> <span class="o">=</span> <span class="n">access_controller</span><span class="o">.</span><span class="n">get_role</span><span class="p">(</span><span class="n">credentials</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">methodname</span> <span class="ow">in</span> <span class="n">SPECIALS</span><span class="p">:</span>
            <span class="c"># Check for valid access based on role.</span>
            <span class="n">access_controller</span><span class="o">.</span><span class="n">check_access</span><span class="p">(</span><span class="n">role</span><span class="p">,</span> <span class="n">methodname</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Check for valid role.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">check_role</span><span class="p">(</span><span class="n">role</span><span class="p">,</span> <span class="n">function</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">RoleError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">RoleError</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">(): </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">methodname</span><span class="p">,</span> <span class="n">exc</span><span class="p">))</span>

            <span class="c"># Set credentials for execution of function. Typically</span>
            <span class="c"># these are just the credentials of the caller, but</span>
            <span class="c"># sometimes a function needs to execute with different</span>
            <span class="c"># credentials.</span>
            <span class="n">credentials</span> <span class="o">=</span> \
                <span class="n">access_controller</span><span class="o">.</span><span class="n">get_proxy_credentials</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">credentials</span><span class="p">)</span>
            <span class="n">set_credentials</span><span class="p">(</span><span class="n">credentials</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">role</span><span class="p">,</span> <span class="n">credentials</span><span class="p">,</span> <span class="n">access_controller</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_form_reply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">ident</span><span class="p">,</span> <span class="n">methodname</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span>
                    <span class="n">access_controller</span><span class="p">,</span> <span class="n">conn</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return reply message for `res`. &quot;&quot;&quot;</span>
        <span class="n">obj</span><span class="p">,</span> <span class="n">exposed</span><span class="p">,</span> <span class="n">gettypeid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_to_obj</span><span class="p">[</span><span class="n">ident</span><span class="p">]</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">typeid</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">ismethod</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="ow">and</span> \
           <span class="p">(</span><span class="n">methodname</span> <span class="o">==</span> <span class="s">&#39;__getattribute__&#39;</span> <span class="ow">or</span> <span class="n">methodname</span> <span class="o">==</span> <span class="s">&#39;__getattr__&#39;</span><span class="p">):</span>
            <span class="c"># More informative for common case of missing RBAC.</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s">&#39;method </span><span class="si">%r</span><span class="s"> of </span><span class="si">%r</span><span class="s"> object is not in exposed=</span><span class="si">%r</span><span class="s">&#39;</span>
                                 <span class="o">%</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span> <span class="n">exposed</span><span class="p">))</span>

        <span class="c"># Proxy pass-through only happens remotely.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">OpenMDAO_Proxy</span><span class="p">):</span>  <span class="c">#pragma no cover</span>
            <span class="n">res_address</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">_token</span><span class="o">.</span><span class="n">address</span>
            <span class="n">res_type</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">address_type</span><span class="p">(</span><span class="n">res_address</span><span class="p">)</span>
            <span class="n">proxy_proxy</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">if</span> <span class="n">res_type</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_address_type</span><span class="p">:</span>
                <span class="n">proxy_proxy</span> <span class="o">=</span> <span class="bp">True</span>  <span class="c"># Different type of connection.</span>
            <span class="k">elif</span> <span class="n">res_type</span> <span class="o">==</span> <span class="s">&#39;AF_INET&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">res_address</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">proxy_proxy</span> <span class="o">=</span> <span class="bp">True</span>  <span class="c"># Different network.</span>
                <span class="k">elif</span> <span class="n">res_address</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;127.0.0.1&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allow_tunneling</span><span class="p">:</span>
                    <span class="n">proxy_proxy</span> <span class="o">=</span> <span class="bp">True</span>  <span class="c"># Access through tunnel.</span>
            <span class="k">if</span> <span class="n">proxy_proxy</span><span class="p">:</span>
                <span class="c"># Create proxy for proxy.</span>
                <span class="n">typeid</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">_token</span><span class="o">.</span><span class="n">typeid</span>
                <span class="n">proxyid</span> <span class="o">=</span> <span class="n">make_typeid</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">LOG_DEBUG2</span><span class="p">,</span> <span class="s">&#39;Creating proxy for proxy </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span>
                                 <span class="n">proxyid</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">proxyid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="n">proxyid</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">_auto_proxy</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># Propagate the proxy info.</span>
                <span class="n">res</span><span class="o">.</span><span class="n">_close</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>  <span class="c"># Don&#39;t decref when reaped.</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;#PROXY&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">_exposed_</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">_token</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">_pubkey</span><span class="p">))</span>

        <span class="k">elif</span> <span class="n">access_controller</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">methodname</span> <span class="ow">in</span> <span class="n">SPECIALS</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">access_controller</span><span class="o">.</span><span class="n">need_proxy</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">res</span><span class="p">):</span>
                    <span class="c"># Create proxy if in declared proxy types.</span>
                    <span class="n">typeid</span> <span class="o">=</span> <span class="n">make_typeid</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
                    <span class="n">proxyid</span> <span class="o">=</span> <span class="n">typeid</span>
                    <span class="k">if</span> <span class="n">typeid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="n">typeid</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">need_proxy</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">access_controller</span><span class="p">):</span>
                <span class="c"># Create proxy if in declared proxy types.</span>
                <span class="n">typeid</span> <span class="o">=</span> <span class="n">make_typeid</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
                <span class="n">proxyid</span> <span class="o">=</span> <span class="n">typeid</span>
                <span class="k">if</span> <span class="n">typeid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="n">typeid</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="c"># Proxy pass-through only happens remotely.</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c">#pragma no cover</span>
            <span class="c"># Create proxy if registered.</span>
            <span class="n">typeid</span> <span class="o">=</span> <span class="n">gettypeid</span> <span class="ow">and</span> <span class="n">gettypeid</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">methodname</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">proxyid</span> <span class="o">=</span> <span class="n">typeid</span>

        <span class="k">if</span> <span class="n">msg</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">typeid</span><span class="p">:</span>
                <span class="n">rident</span><span class="p">,</span> <span class="n">rexposed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">proxyid</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
                <span class="n">token</span> <span class="o">=</span> <span class="n">Token</span><span class="p">(</span><span class="n">typeid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">rident</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">LOG_DEBUG2</span><span class="p">,</span> <span class="s">&#39;Returning proxy for </span><span class="si">%s</span><span class="s"> at </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span>
                                 <span class="n">typeid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key_pair</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">pubkey</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pubkey</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key_pair</span><span class="o">.</span><span class="n">publickey</span><span class="p">()</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;#PROXY&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">rexposed</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">pubkey</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;#RETURN&#39;</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">msg</span>

    <span class="k">def</span> <span class="nf">_fallback_isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">ident</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">typename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Check if `obj` is an instance of `typename`. &quot;&quot;&quot;</span>
        <span class="c"># It&#39;s very difficult to get an arbitrary `typename` here.</span>
        <span class="n">dot</span> <span class="o">=</span> <span class="n">typename</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
        <span class="n">module_name</span> <span class="o">=</span> <span class="n">typename</span><span class="p">[:</span><span class="n">dot</span><span class="p">]</span>
        <span class="n">class_name</span> <span class="o">=</span> <span class="n">typename</span><span class="p">[</span><span class="n">dot</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">module</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>  <span class="c">#pragma no cover</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="n">module</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">module_name</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cls</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">class_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>  <span class="c">#pragma no cover</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">cls</span><span class="p">)</span>

    <span class="n">Server</span><span class="o">.</span><span class="n">fallback_mapping</span><span class="p">[</span><span class="s">&#39;__is_instance__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_fallback_isinstance</span>

    <span class="k">def</span> <span class="nf">_fallback_hasinterface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">ident</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">typename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Check if `obj` supports `typename`. &quot;&quot;&quot;</span>
        <span class="c"># It&#39;s very difficult to get an arbitrary `typename` here.</span>
        <span class="n">dot</span> <span class="o">=</span> <span class="n">typename</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
        <span class="n">module_name</span> <span class="o">=</span> <span class="n">typename</span><span class="p">[:</span><span class="n">dot</span><span class="p">]</span>
        <span class="n">class_name</span> <span class="o">=</span> <span class="n">typename</span><span class="p">[</span><span class="n">dot</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">module</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>  <span class="c">#pragma no cover</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="n">module</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">module_name</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cls</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">class_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>  <span class="c">#pragma no cover</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="n">obj_has_interface</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">cls</span><span class="p">)</span>

    <span class="n">Server</span><span class="o">.</span><span class="n">fallback_mapping</span><span class="p">[</span><span class="s">&#39;__has_interface__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_fallback_hasinterface</span>

    <span class="c"># This is for low-level debugging of servers.</span>
<div class="viewcode-block" id="OpenMDAO_Server.debug_info"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.mp_support.OpenMDAO_Server.debug_info">[docs]</a>    <span class="k">def</span> <span class="nf">debug_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">):</span>  <span class="c">#pragma no cover</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return string representing state of id_to_obj mapping.</span>

<span class="sd">        conn: socket or pipe</span>
<span class="sd">            Unused.</span>

<span class="sd">        This version handles proxies in a special manner.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mutex</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_to_obj</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="n">keys</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">ident</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ident</span> <span class="o">!=</span> <span class="s">&#39;0&#39;</span><span class="p">:</span>
                    <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_to_obj</span><span class="p">[</span><span class="n">ident</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">BaseProxy</span><span class="p">):</span>
                        <span class="n">obj_str</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> proxy for </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> \
                                  <span class="o">%</span> <span class="p">(</span><span class="n">keytype</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">_authkey</span><span class="p">),</span> <span class="n">obj</span><span class="o">.</span><span class="n">_id</span><span class="p">,</span>
                                     <span class="n">obj</span><span class="o">.</span><span class="n">_token</span><span class="o">.</span><span class="n">typeid</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">obj_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">)[:</span><span class="mi">75</span><span class="p">]</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;  </span><span class="si">%s</span><span class="s">:       refcount=</span><span class="si">%s</span><span class="se">\n</span><span class="s">    </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
                                  <span class="p">(</span><span class="n">ident</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_to_refcount</span><span class="p">[</span><span class="n">ident</span><span class="p">],</span> <span class="n">obj_str</span><span class="p">))</span>
            <span class="k">return</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mutex</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="OpenMDAO_Server.create"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.mp_support.OpenMDAO_Server.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">typeid</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new shared object and return its id.</span>

<span class="sd">        conn: socket or pipe</span>
<span class="sd">            Connection to process.</span>

<span class="sd">        typeid: string</span>
<span class="sd">            Identifier string for type of object to be created.</span>

<span class="sd">        This version uses :func:`public_methods`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mutex</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">callable</span><span class="p">,</span> <span class="n">exposed</span><span class="p">,</span> <span class="n">method_to_typeid</span><span class="p">,</span> <span class="n">proxytype</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="n">typeid</span><span class="p">]</span>
            <span class="c"># Just being defensive.</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>  <span class="c">#pragma no cover</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;mp_support.create: </span><span class="si">%r</span><span class="s"> registry&#39;</span><span class="p">,</span> <span class="n">typeid</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;    </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="k">raise</span>

            <span class="k">if</span> <span class="nb">callable</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">kwds</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="nb">callable</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">exposed</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">exposed</span> <span class="o">=</span> <span class="n">public_methods</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">method_to_typeid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">method_to_typeid</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span>
                <span class="n">exposed</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">exposed</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">method_to_typeid</span><span class="p">)</span>

            <span class="n">ident</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%x</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">id</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>  <span class="c"># convert to string because xmlrpclib</span>
                                    <span class="c"># only has 32 bit signed integers</span>
            <span class="n">util</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%r</span><span class="s"> callable returned object with id </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">typeid</span><span class="p">,</span> <span class="n">ident</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">id_to_obj</span><span class="p">[</span><span class="n">ident</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">exposed</span><span class="p">),</span> <span class="n">method_to_typeid</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ident</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_to_refcount</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">id_to_refcount</span><span class="p">[</span><span class="n">ident</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c"># increment the reference count immediately, to avoid</span>
            <span class="c"># this object being garbage collected before a Proxy</span>
            <span class="c"># object for it can be created.  The caller of create()</span>
            <span class="c"># is responsible for doing a decref once the Proxy object</span>
            <span class="c"># has been created.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">incref</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">ident</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ident</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">exposed</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mutex</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

    <span class="c"># Will only be seen on remote.</span></div>
<div class="viewcode-block" id="OpenMDAO_Server.shutdown"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.mp_support.OpenMDAO_Server.shutdown">[docs]</a>    <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">):</span>  <span class="c">#pragma no cover</span>
        <span class="sd">&quot;&quot;&quot; Shutdown this process. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">=</span> <span class="mi">888</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;received shutdown request, running exit functions&#39;</span>
        <span class="k">print</span> <span class="n">msg</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">remove_remote_handlers</span><span class="p">()</span>

        <span class="c"># Deprecated, but marginally better than atexit._run_exitfuncs()</span>
        <span class="c"># Don&#39;t try to log here, logging shuts-down via atexit.</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="s">&#39;exitfunc&#39;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exitfunc</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&#39;sys.exitfunc(): </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">exc</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="k">print</span> <span class="s">&#39;    exit functions complete&#39;</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">OpenMDAO_Server</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">shutdown</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="OpenMDAO_Manager"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.mp_support.OpenMDAO_Manager">[docs]</a><span class="k">class</span> <span class="nc">OpenMDAO_Manager</span><span class="p">(</span><span class="n">BaseManager</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Uses :class:`OpenMDAO_Server`, retains the public key, and puts some slack</span>
<span class="sd">    in shutdown timing.</span>

<span class="sd">    address: tuple or string</span>
<span class="sd">        A :mod:`multiprocessing` address specifying an Internet address or</span>
<span class="sd">        a pipe.</span>

<span class="sd">    authkey: string</span>
<span class="sd">        Authorization key. Inherited from the current :class:`Process`</span>
<span class="sd">        object if not specified.</span>

<span class="sd">    serializer: string</span>
<span class="sd">        Which serialization method to use.</span>

<span class="sd">    pubkey: public key</span>
<span class="sd">        Public portion of server&#39;s public/private key pair.</span>
<span class="sd">        Needed for client/proxy side.</span>

<span class="sd">    name: string</span>
<span class="sd">        Name for server, used in log files, etc.</span>

<span class="sd">    allowed_hosts: list(string)</span>
<span class="sd">        Host address patterns to check against.</span>

<span class="sd">    allowed_users: dict</span>
<span class="sd">        Dictionary of users and corresponding public keys allowed access.</span>
<span class="sd">        If None, any user may access. If empty, no user may access.</span>

<span class="sd">    allow_tunneling: bool</span>
<span class="sd">        If True, allow connections from 127.0.0.1 (localhost), even if not</span>
<span class="sd">        listed otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_Server</span> <span class="o">=</span> <span class="n">OpenMDAO_Server</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">authkey</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">serializer</span><span class="o">=</span><span class="s">&#39;pickle&#39;</span><span class="p">,</span>
                 <span class="n">pubkey</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">allowed_hosts</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">allowed_users</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">allow_tunneling</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">OpenMDAO_Manager</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">authkey</span><span class="p">,</span> <span class="n">serializer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pubkey</span> <span class="o">=</span> <span class="n">pubkey</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_allowed_hosts</span> <span class="o">=</span> <span class="n">allowed_hosts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_allowed_users</span> <span class="o">=</span> <span class="n">allowed_users</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_allow_tunneling</span> <span class="o">=</span> <span class="n">allow_tunneling</span>

<div class="viewcode-block" id="OpenMDAO_Manager.get_server"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.mp_support.OpenMDAO_Manager.get_server">[docs]</a>    <span class="k">def</span> <span class="nf">get_server</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a server object with :meth:`serve_forever` and address attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">State</span><span class="o">.</span><span class="n">INITIAL</span>
        <span class="k">return</span> <span class="n">OpenMDAO_Server</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_address</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_authkey</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">_allowed_hosts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allowed_users</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">_allow_tunneling</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="OpenMDAO_Manager.start"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.mp_support.OpenMDAO_Manager.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Spawn a server process for this manager object.</span>

<span class="sd">        cwd: string</span>
<span class="sd">            Directory to start in.</span>

<span class="sd">        log_level: int</span>
<span class="sd">            Initial root logging level for the server process.</span>

<span class="sd">        This version retrieves the server&#39;s public key.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">State</span><span class="o">.</span><span class="n">INITIAL</span>

        <span class="c"># Pipe over which we will retrieve address of server.</span>
        <span class="n">reader</span><span class="p">,</span> <span class="n">writer</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">Pipe</span><span class="p">(</span><span class="n">duplex</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&#39;win32&#39;</span><span class="p">:</span>  <span class="c">#pragma no cover</span>
            <span class="c"># Make registry pickleable.</span>
            <span class="n">registry</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">typeid</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">callable</span><span class="p">,</span> <span class="n">exposed</span><span class="p">,</span> <span class="n">method_to_typeid</span><span class="p">,</span> <span class="n">proxytype</span> <span class="o">=</span> <span class="n">info</span>
                <span class="k">if</span> <span class="n">proxytype</span> <span class="ow">and</span> <span class="n">proxytype</span> <span class="o">!=</span> <span class="n">_auto_proxy</span><span class="p">:</span>
                    <span class="n">registry</span><span class="p">[</span><span class="n">typeid</span><span class="p">]</span> <span class="o">=</span> \
                        <span class="p">(</span><span class="nb">callable</span><span class="p">,</span> <span class="n">exposed</span><span class="p">,</span> <span class="n">method_to_typeid</span><span class="p">,</span> <span class="s">&#39;rebuild&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">registry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span>

        <span class="c"># Flush logs before cloning.</span>
        <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">logging</span><span class="o">.</span><span class="n">_handlerList</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">handler</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">h</span> <span class="o">=</span> <span class="n">handler</span><span class="p">()</span>  <span class="c"># WeakRef</span>
                <span class="k">if</span> <span class="n">h</span><span class="p">:</span>
                    <span class="n">h</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="c"># Spawn process which runs a server.</span>
        <span class="n">credentials</span> <span class="o">=</span> <span class="n">get_credentials</span><span class="p">()</span>
        <span class="n">log_port</span> <span class="o">=</span> <span class="n">logging_port</span><span class="p">(</span><span class="s">&#39;localhost&#39;</span><span class="p">,</span> <span class="s">&#39;localhost&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_process</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span>
            <span class="n">target</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_run_server</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">registry</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_address</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_authkey</span><span class="p">,</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allowed_hosts</span><span class="p">,</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">_allowed_users</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allow_tunneling</span><span class="p">,</span>
                  <span class="n">writer</span><span class="p">,</span> <span class="n">credentials</span><span class="p">,</span> <span class="n">cwd</span><span class="p">,</span> <span class="n">log_port</span><span class="p">,</span> <span class="n">log_level</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="n">ident</span> <span class="o">=</span> <span class="s">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process</span><span class="o">.</span><span class="n">_identity</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_process</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__name__</span>  <span class="o">+</span> <span class="s">&#39;-&#39;</span> <span class="o">+</span> <span class="n">ident</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_process</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process</span><span class="o">.</span><span class="n">pid</span>

        <span class="c"># Get address of server.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_authkey</span> <span class="o">==</span> <span class="s">&#39;PublicKey&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&#39;win32&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">HAVE_PYWIN32</span><span class="p">:</span>  <span class="c">#pragma no cover</span>
                <span class="n">timeout</span> <span class="o">=</span> <span class="mi">120</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">timeout</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">timeout</span> <span class="o">=</span> <span class="mi">10</span>

        <span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">retry</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">timeout</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">reader</span><span class="o">.</span><span class="n">poll</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="s">&#39;Server process </span><span class="si">%d</span><span class="s"> exited: </span><span class="si">%s</span><span class="s">&#39;</span> \
                            <span class="o">%</span> <span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process</span><span class="o">.</span><span class="n">exitcode</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="c"># Hard to cause a timeout.</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c">#pragma no cover</span>
            <span class="k">if</span> <span class="n">error_msg</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">et</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_process</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="s">&#39;Server process </span><span class="si">%d</span><span class="s"> startup timed-out in </span><span class="si">%.2f</span><span class="s">&#39;</span> \
                            <span class="o">%</span> <span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">et</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">error_msg</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">reply</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>  <span class="c"># str(Exception()) is null, repr() isn&#39;t.</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="s">&#39;Server process </span><span class="si">%d</span><span class="s"> read failed: </span><span class="si">%s</span><span class="s">&#39;</span> \
                            <span class="o">%</span> <span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">repr</span><span class="p">(</span><span class="n">exc</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reply</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">):</span>
                    <span class="n">error_msg</span> <span class="o">=</span> <span class="s">&#39;Server process </span><span class="si">%d</span><span class="s"> startup failed: </span><span class="si">%s</span><span class="s">&#39;</span> \
                                 <span class="o">%</span> <span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">reply</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">repr</span><span class="p">(</span><span class="n">reply</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">error_msg</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cwd</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;    in dir </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">cwd</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;stdout&#39;</span><span class="p">,</span> <span class="s">&#39;stderr&#39;</span><span class="p">,</span> <span class="s">&#39;openmdao_log*.txt&#39;</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cwd</span><span class="p">,</span> <span class="n">name</span><span class="p">)):</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">inp</span><span class="p">:</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;    </span><span class="si">%s</span><span class="s">:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">inp</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_address</span> <span class="o">=</span> <span class="n">reply</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_authkey</span> <span class="o">==</span> <span class="s">&#39;PublicKey&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pubkey</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
        <span class="n">reader</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">et</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Server process </span><span class="si">%d</span><span class="s"> startup in </span><span class="si">%.2f</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">et</span><span class="p">)</span>

        <span class="c"># Register a finalizer.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">State</span><span class="o">.</span><span class="n">STARTED</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">Finalize</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_finalize_manager</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_process</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_address</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_authkey</span><span class="p">,</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Client</span><span class="p">),</span>
            <span class="n">exitpriority</span><span class="o">=</span><span class="mi">0</span>
            <span class="p">)</span>

    <span class="c"># This happens on the remote server side and we&#39;ll check when using it.</span></div>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_run_server</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">registry</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">authkey</span><span class="p">,</span> <span class="n">serializer</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
                    <span class="n">allowed_hosts</span><span class="p">,</span> <span class="n">allowed_users</span><span class="p">,</span> <span class="n">allow_tunneling</span><span class="p">,</span>
                    <span class="n">writer</span><span class="p">,</span> <span class="n">credentials</span><span class="p">,</span> <span class="n">cwd</span><span class="p">,</span> <span class="n">log_port</span><span class="p">,</span> <span class="n">log_level</span><span class="p">):</span> <span class="c">#pragma no cover</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a server, report its address and public key, and run it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&#39;win32&#39;</span><span class="p">:</span>
                <span class="n">set_credentials</span><span class="p">(</span><span class="n">credentials</span><span class="p">)</span>
                <span class="c"># Recreate registry proxytypes.</span>
                <span class="k">for</span> <span class="n">typeid</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">registry</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="nb">callable</span><span class="p">,</span> <span class="n">exposed</span><span class="p">,</span> <span class="n">method_to_typeid</span><span class="p">,</span> <span class="n">proxytype</span> <span class="o">=</span> <span class="n">info</span>
                    <span class="k">if</span> <span class="n">proxytype</span> <span class="o">==</span> <span class="s">&#39;rebuild&#39;</span><span class="p">:</span>
                        <span class="n">registry</span><span class="p">[</span><span class="n">typeid</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">callable</span><span class="p">,</span> <span class="n">exposed</span><span class="p">,</span> <span class="n">method_to_typeid</span><span class="p">,</span>
                                            <span class="n">_make_proxy_type</span><span class="p">(</span><span class="n">typeid</span><span class="p">,</span> <span class="n">exposed</span><span class="p">))</span>

            <span class="c"># If specified, move to new directory.</span>
            <span class="k">if</span> <span class="n">cwd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>

                <span class="c"># Cleanup cloned logging environment.</span>
                <span class="k">del</span> <span class="n">logging</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">handlers</span><span class="p">[:]</span>
                <span class="k">del</span> <span class="n">logging</span><span class="o">.</span><span class="n">_handlerList</span><span class="p">[:]</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">_handlers</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

                <span class="c"># Reset stdout &amp; stderr.</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;stdout&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;stderr&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>

                <span class="c"># Reset logging.</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">log_level</span><span class="p">,</span>
                    <span class="n">datefmt</span><span class="o">=</span><span class="s">&#39;%b </span><span class="si">%d</span><span class="s"> %H:%M:%S&#39;</span><span class="p">,</span>
                    <span class="n">format</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%(asctime)s</span><span class="s"> </span><span class="si">%(levelname)s</span><span class="s"> </span><span class="si">%(name)s</span><span class="s">: </span><span class="si">%(message)s</span><span class="s">&#39;</span><span class="p">,</span>
                    <span class="n">filename</span><span class="o">=</span><span class="s">&#39;openmdao_log.txt&#39;</span><span class="p">,</span> <span class="n">filemode</span><span class="o">=</span><span class="s">&#39;w&#39;</span><span class="p">)</span>

                <span class="c"># Connect to remote logging server.</span>
                <span class="k">if</span> <span class="n">log_port</span><span class="p">:</span>
                    <span class="n">install_remote_handler</span><span class="p">(</span><span class="s">&#39;localhost&#39;</span><span class="p">,</span> <span class="n">log_port</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

            <span class="c"># Create server.</span>
            <span class="n">server</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">_Server</span><span class="p">(</span><span class="n">registry</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">authkey</span><span class="p">,</span> <span class="n">serializer</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
                                 <span class="n">allowed_hosts</span><span class="p">,</span> <span class="n">allowed_users</span><span class="p">,</span> <span class="n">allow_tunneling</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Inform parent process of the server&#39;s address.</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">server</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">authkey</span> <span class="o">==</span> <span class="s">&#39;PublicKey&#39;</span><span class="p">:</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">server</span><span class="o">.</span><span class="n">public_key</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c"># Run the manager.</span>
        <span class="n">util</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;manager serving at </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">server</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
        <span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_finalize_manager</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">authkey</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_Client</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Shutdown the manager process; will be registered as a finalizer.</span>
<span class="sd">        This version uses relaxed timing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;sending shutdown message to manager&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">conn</span> <span class="o">=</span> <span class="n">_get_connection</span><span class="p">(</span><span class="n">_Client</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">authkey</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dispatch</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;shutdown&#39;</span><span class="p">)</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="c"># Just being defensive here.</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c">#pragma no cover</span>
                <span class="k">pass</span>

            <span class="n">process</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="c"># No good way to cause process to not shut down.</span>
            <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>  <span class="c">#pragma no cover</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;manager still alive after shutdown request&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="s">&#39;terminate&#39;</span><span class="p">):</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;trying to `terminate()` manager process&#39;</span><span class="p">)</span>
                    <span class="n">process</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
                    <span class="n">process</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;manager still alive after terminate&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">!=</span> <span class="s">&#39;win32&#39;</span><span class="p">:</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">pid</span><span class="o">.</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGKILL</span><span class="p">)</span>
                        <span class="n">process</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;manager still alive after kill&#39;</span><span class="p">)</span>

        <span class="n">state</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">State</span><span class="o">.</span><span class="n">SHUTDOWN</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">BaseProxy</span><span class="o">.</span><span class="n">_address_to_local</span><span class="p">[</span><span class="n">address</span><span class="p">]</span>
        <span class="c"># Just being defensive here.</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>  <span class="c">#pragma no cover</span>
            <span class="k">pass</span>

</div>
<div class="viewcode-block" id="ObjectManager"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.mp_support.ObjectManager">[docs]</a><span class="k">class</span> <span class="nc">ObjectManager</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Provides a multiprocessing interface for an existing object.</span>

<span class="sd">    obj: object</span>
<span class="sd">        Object to provide remote access to.</span>

<span class="sd">    address: tuple or string</span>
<span class="sd">        A :mod:`multiprocessing` address specifying an Internet address or</span>
<span class="sd">        a pipe.</span>

<span class="sd">    serializer: string</span>
<span class="sd">        Which serialization method to use.</span>

<span class="sd">    authkey: string</span>
<span class="sd">        Authorization key. Inherited from the current :class:`Process`</span>
<span class="sd">        object if not specified.</span>

<span class="sd">    name: string</span>
<span class="sd">        Name for server, used in log files, etc.</span>

<span class="sd">    allowed_hosts: list(string)</span>
<span class="sd">        Host address patterns to check against.</span>

<span class="sd">    allowed_users: dict</span>
<span class="sd">        Dictionary of users and corresponding public keys allowed access.</span>
<span class="sd">        If None, any user may access. If empty, no user may access.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">serializer</span><span class="o">=</span><span class="s">&#39;pickle&#39;</span><span class="p">,</span> <span class="n">authkey</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">allowed_hosts</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">allowed_users</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_typeid</span> <span class="o">=</span> <span class="n">make_typeid</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ident</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%x</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">id</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;ObjectManager address </span><span class="si">%s</span><span class="s">, </span><span class="si">%r</span><span class="s">, name </span><span class="si">%r</span><span class="s">, ident </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span>
                      <span class="n">address</span><span class="p">,</span> <span class="n">keytype</span><span class="p">(</span><span class="n">authkey</span><span class="p">),</span> <span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ident</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_manager</span> <span class="o">=</span> <span class="n">OpenMDAO_Manager</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="n">address</span><span class="p">,</span> <span class="n">serializer</span><span class="o">=</span><span class="n">serializer</span><span class="p">,</span>
                                         <span class="n">authkey</span><span class="o">=</span><span class="n">authkey</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                                         <span class="n">allowed_hosts</span><span class="o">=</span><span class="n">allowed_hosts</span><span class="p">,</span>
                                         <span class="n">allowed_users</span><span class="o">=</span><span class="n">allowed_users</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_server</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manager</span><span class="o">.</span><span class="n">get_server</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exposed</span> <span class="o">=</span> <span class="n">public_methods</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server</span><span class="o">.</span><span class="n">mutex</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_server</span><span class="o">.</span><span class="n">id_to_obj</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ident</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exposed</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_server</span><span class="o">.</span><span class="n">id_to_refcount</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ident</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_server_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_run_server</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_server_thread</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_server_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_proxy</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="nd">@property</span>
<div class="viewcode-block" id="ObjectManager.proxy"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.mp_support.ObjectManager.proxy">[docs]</a>    <span class="k">def</span> <span class="nf">proxy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Proxy for our object server. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proxy</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">token</span> <span class="o">=</span> <span class="n">Token</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_typeid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ident</span><span class="p">)</span>
            <span class="n">authkey</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server</span><span class="o">.</span><span class="n">_authkey</span>
            <span class="n">pubkey</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server</span><span class="o">.</span><span class="n">public_key</span> <span class="k">if</span> <span class="n">authkey</span> <span class="o">==</span> <span class="s">&#39;PublicKey&#39;</span> <span class="k">else</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_proxy</span> <span class="o">=</span> <span class="n">_auto_proxy</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manager</span><span class="o">.</span><span class="n">_serializer</span><span class="p">,</span>
                                      <span class="n">authkey</span><span class="o">=</span><span class="n">authkey</span><span class="p">,</span> <span class="n">exposed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_exposed</span><span class="p">,</span>
                                      <span class="n">pubkey</span><span class="o">=</span><span class="n">pubkey</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_server</span><span class="o">.</span><span class="n">incref</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ident</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proxy</span>
</div>
    <span class="k">def</span> <span class="nf">_run_server</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Run a manager server (in a separate thread!). &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="OpenMDAO_Proxy"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.mp_support.OpenMDAO_Proxy">[docs]</a><span class="k">class</span> <span class="nc">OpenMDAO_Proxy</span><span class="p">(</span><span class="n">BaseProxy</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Proxy for a remote object.</span>

<span class="sd">    args: tuple</span>
<span class="sd">        Passed to :class:`BaseProxy`.</span>

<span class="sd">    kwds: dict</span>
<span class="sd">        If it contains `pubkey`, then that value is used for the remote public</span>
<span class="sd">        key, and the entry is removed before being passed to :class:`BaseProxy`.</span>

<span class="sd">    This version sends credentials and provides dynamic result proxy generation.</span>

<span class="sd">    .. note::</span>

<span class="sd">        :meth:`BaseProxy.__str__` (used by :meth:`str` and the ``%s`` format)</span>
<span class="sd">        will return :meth:`__repr__` of the remote object.  To avoid the</span>
<span class="sd">        network round-trip delay, use :meth:`repr` or the ``%r`` format.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pubkey</span> <span class="o">=</span> <span class="n">kwds</span><span class="p">[</span><span class="s">&#39;pubkey&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">pubkey</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">kwds</span><span class="p">[</span><span class="s">&#39;pubkey&#39;</span><span class="p">]</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">OpenMDAO_Proxy</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manager</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pubkey</span> <span class="o">=</span> <span class="n">pubkey</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pubkey</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manager</span><span class="o">.</span><span class="n">_pubkey</span>

    <span class="k">def</span> <span class="nf">_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This version translates tunneled addresses. &quot;&quot;&quot;</span>
        <span class="n">util</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;making connection to manager&#39;</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">current_process</span><span class="p">()</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s">&#39;MainThread&#39;</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">+=</span> <span class="s">&#39;|&#39;</span> <span class="o">+</span> <span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span><span class="o">.</span><span class="n">name</span>
        <span class="n">address</span> <span class="o">=</span> <span class="n">tunnel_address</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_token</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Client</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">authkey</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_authkey</span><span class="p">)</span>
        <span class="n">dispatch</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;accept_connection&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tls</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">conn</span>

    <span class="k">def</span> <span class="nf">_callmethod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methodname</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">kwds</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Try to call a method of the referrent and return a copy of the result.</span>
<span class="sd">        This version optionally encrypts the channel and sends the current</span>
<span class="sd">        thread&#39;s credentials with method arguments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">()</span>
        <span class="n">kwds</span> <span class="o">=</span> <span class="n">kwds</span> <span class="ow">or</span> <span class="p">{}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tls</span><span class="o">.</span><span class="n">connection</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">curr_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span>
            <span class="n">util</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;thread </span><span class="si">%r</span><span class="s"> does not own a connection&#39;</span><span class="p">,</span> <span class="n">curr_thread</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_connect</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Can&#39;t connect to server at </span><span class="si">%r</span><span class="s"> for </span><span class="si">%r</span><span class="s">: </span><span class="si">%r</span><span class="s">&quot;</span> \
                      <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_token</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">methodname</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tls</span><span class="o">.</span><span class="n">connection</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_authkey</span> <span class="o">==</span> <span class="s">&#39;PublicKey&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_init_session</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_tls</span><span class="o">.</span><span class="n">session_key</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

        <span class="n">session_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tls</span><span class="o">.</span><span class="n">session_key</span>

<span class="c"># FIXME: Bizarre problem evidenced by test_extcode.py (Python 2.6.1)</span>
<span class="c"># For some reason pickling the env_vars dictionary causes:</span>
<span class="c">#    PicklingError: Can&#39;t pickle &lt;class &#39;openmdao.main.mp_support.ObjServer&#39;&gt;:</span>
<span class="c">#                     attribute lookup openmdao.main.mp_support.ObjServer failed</span>
<span class="c"># The reported type is not in the (current) Dict items.</span>
<span class="c"># Apparently this is some Traits &#39;feature&#39;.</span>
        <span class="n">new_args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">TraitDictObject</span><span class="p">):</span>
                <span class="n">new_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">encrypt</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">,</span> <span class="n">methodname</span><span class="p">,</span> <span class="n">new_args</span><span class="p">,</span> <span class="n">kwds</span><span class="p">,</span>
                               <span class="n">get_credentials</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">()),</span> <span class="n">session_key</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Can&#39;t send to server at </span><span class="si">%r</span><span class="s"> for </span><span class="si">%r</span><span class="s">: </span><span class="si">%r</span><span class="s">&quot;</span> \
                  <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_token</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">methodname</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">kind</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="n">decrypt</span><span class="p">(</span><span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(),</span> <span class="n">session_key</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s">&#39;#RETURN&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s">&#39;#PROXY&#39;</span><span class="p">:</span>
            <span class="n">exposed</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">pubkey</span> <span class="o">=</span> <span class="n">result</span>

            <span class="c"># Proxy passthru only happens remotely.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manager</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>  <span class="c">#pragma no cover</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_manager</span> <span class="o">=</span> <span class="n">OpenMDAO_Manager</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_authkey</span><span class="p">,</span>
                                                 <span class="n">pubkey</span><span class="o">=</span><span class="n">pubkey</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">proxytype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manager</span><span class="o">.</span><span class="n">_registry</span><span class="p">[</span><span class="n">token</span><span class="o">.</span><span class="n">typeid</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">proxytype</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="n">proxytype</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_manager</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">typeid</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">_auto_proxy</span><span class="p">)</span>
                <span class="n">proxytype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manager</span><span class="o">.</span><span class="n">_registry</span><span class="p">[</span><span class="n">token</span><span class="o">.</span><span class="n">typeid</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">address</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manager</span><span class="o">.</span><span class="n">address</span><span class="p">:</span>
                <span class="c"># Proxy to different server than request was sent to.</span>
                <span class="n">manager</span> <span class="o">=</span> <span class="n">OpenMDAO_Manager</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_authkey</span><span class="p">,</span>
                                           <span class="n">pubkey</span><span class="o">=</span><span class="n">pubkey</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">manager</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manager</span>

            <span class="n">proxy</span> <span class="o">=</span> <span class="n">proxytype</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">manager</span><span class="p">,</span>
                              <span class="n">authkey</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_authkey</span><span class="p">,</span> <span class="n">exposed</span><span class="o">=</span><span class="n">exposed</span><span class="p">,</span>
                              <span class="n">pubkey</span><span class="o">=</span><span class="n">pubkey</span><span class="p">)</span>

            <span class="n">conn</span> <span class="o">=</span> <span class="n">_get_connection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Client</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_authkey</span><span class="p">)</span>
            <span class="n">dispatch</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;decref&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">id</span><span class="p">,))</span>
            <span class="k">return</span> <span class="n">proxy</span>

        <span class="k">raise</span> <span class="n">convert_to_error</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_init_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Send client public key, receive session key. &quot;&quot;&quot;</span>
        <span class="n">key_pair</span> <span class="o">=</span> <span class="n">get_key_pair</span><span class="p">(</span><span class="n">Credentials</span><span class="o">.</span><span class="n">user_host</span><span class="p">)</span>
        <span class="n">public_key</span> <span class="o">=</span> <span class="n">key_pair</span><span class="o">.</span><span class="n">publickey</span><span class="p">()</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">encode_public_key</span><span class="p">(</span><span class="n">public_key</span><span class="p">)</span>

        <span class="n">server_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pubkey</span>
        <span class="n">encrypted</span> <span class="o">=</span> <span class="n">pk_encrypt</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">server_key</span><span class="p">)</span>
        <span class="n">client_version</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">((</span><span class="n">client_version</span><span class="p">,</span> <span class="n">server_key</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="n">server_key</span><span class="o">.</span><span class="n">e</span><span class="p">,</span> <span class="n">encrypted</span><span class="p">))</span>

        <span class="n">server_data</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
        <span class="n">server_version</span> <span class="o">=</span> <span class="n">server_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c"># Just being defensive, this should never happen.</span>
        <span class="k">if</span> <span class="n">server_version</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>  <span class="c">#pragma no cover</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Expecting server protocol version 1, got </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">server_version</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">server_version</span> <span class="o">==</span> <span class="s">&#39;#TRACEBACK&#39;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">server_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_tls</span><span class="o">.</span><span class="n">session_key</span> <span class="o">=</span> <span class="n">key_pair</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">server_data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_incref</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tell server to increment its reference count.</span>
<span class="sd">        This version avoids a hang in _Client if the server no longer exists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Hard to cause this to happen.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">OpenMDAO_Proxy</span><span class="o">.</span><span class="n">manager_is_alive</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_token</span><span class="o">.</span><span class="n">address</span><span class="p">):</span>  <span class="c">#pragma no cover</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;Cannot connect to manager at </span><span class="si">%r</span><span class="s">&#39;</span> 
                               <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_token</span><span class="o">.</span><span class="n">address</span><span class="p">,))</span>

        <span class="n">conn</span> <span class="o">=</span> <span class="n">_get_connection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Client</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_token</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_authkey</span><span class="p">)</span>
        <span class="n">dispatch</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;incref&#39;</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">,))</span>
        <span class="c"># Enable this with care. While testing CaseIteratorDriver it can cause a</span>
        <span class="c"># deadlock in logging (called via BaseProxy._after_fork()).</span>
        <span class="c">#util.debug(&#39;INCREF %r&#39;, self._token.id)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_idset</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">)</span>

        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manager</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manager</span><span class="o">.</span><span class="n">_state</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_close</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">Finalize</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">OpenMDAO_Proxy</span><span class="o">.</span><span class="n">_decref</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_authkey</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">_tls</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Client</span><span class="p">),</span>
            <span class="n">exitpriority</span><span class="o">=</span><span class="mi">10</span>
            <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_decref</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">authkey</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">tls</span><span class="p">,</span> <span class="n">idset</span><span class="p">,</span> <span class="n">_Client</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tell server to decrement its reference count.</span>
<span class="sd">        This version avoids a hang in _Client if the server no longer exists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">idset</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="c"># check whether manager is still alive</span>
        <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">state</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">State</span><span class="o">.</span><span class="n">STARTED</span><span class="p">:</span>
            <span class="c"># Avoid a hang in _Client() if the server isn&#39;t there anymore.</span>
            <span class="k">if</span> <span class="n">OpenMDAO_Proxy</span><span class="o">.</span><span class="n">manager_is_alive</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">address</span><span class="p">):</span>
                <span class="c"># tell manager this process no longer cares about referent</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">util</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;DECREF </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                    <span class="n">conn</span> <span class="o">=</span> <span class="n">_get_connection</span><span class="p">(</span><span class="n">_Client</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">authkey</span><span class="p">)</span>
                    <span class="n">dispatch</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;decref&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">id</span><span class="p">,))</span>
                <span class="c"># Hard to cause this to happen.</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>  <span class="c">#pragma no cover</span>
                    <span class="n">util</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;... decref failed </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">util</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;DECREF </span><span class="si">%r</span><span class="s"> -- manager already shutdown&#39;</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="c"># check whether we can close this thread&#39;s connection because</span>
        <span class="c"># the process owns no more references to objects for this manager</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">idset</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">tls</span><span class="p">,</span> <span class="s">&#39;connection&#39;</span><span class="p">):</span>
            <span class="n">util</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;thread </span><span class="si">%r</span><span class="s"> has no more </span><span class="si">%r</span><span class="s"> proxies so closing conn&#39;</span><span class="p">,</span>
                       <span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">typeid</span><span class="p">)</span>
            <span class="n">tls</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">del</span> <span class="n">tls</span><span class="o">.</span><span class="n">connection</span>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="OpenMDAO_Proxy.manager_is_alive"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.mp_support.OpenMDAO_Proxy.manager_is_alive">[docs]</a>    <span class="k">def</span> <span class="nf">manager_is_alive</span><span class="p">(</span><span class="n">address</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check whether manager is still alive.</span>

<span class="sd">        address: tuple or string</span>
<span class="sd">            A :mod:`multiprocessing` address specifying an Internet address or</span>
<span class="sd">            a pipe.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">addr_type</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">address_type</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">addr_type</span> <span class="o">==</span> <span class="s">&#39;AF_PIPE&#39;</span><span class="p">:</span>  <span class="c">#pragma no cover</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">win32</span><span class="o">.</span><span class="n">WaitNamedPipe</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>  <span class="c"># 0.01 sec</span>
            <span class="k">except</span> <span class="ne">WindowsError</span><span class="p">:</span>
                <span class="n">alive</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">alive</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">addr_type</span> <span class="o">==</span> <span class="s">&#39;AF_INET&#39;</span><span class="p">:</span>
                <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">addr_type</span> <span class="o">==</span> <span class="s">&#39;AF_UNIX&#39;</span><span class="p">:</span>
                <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_UNIX</span><span class="p">)</span>

            <span class="n">address</span> <span class="o">=</span> <span class="n">tunnel_address</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sock</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">exc</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">ECONNREFUSED</span> <span class="ow">or</span> \
                   <span class="n">exc</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENOENT</span><span class="p">:</span>
                    <span class="n">alive</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="c"># Just being defensive.</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c">#pragma no cover</span>
                    <span class="k">raise</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">alive</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="n">alive</span>
</div>
    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; For unpickling.  This version uses :func:`_auto_proxy`. &quot;&quot;&quot;</span>
        <span class="n">kwds</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">kwds</span><span class="p">[</span><span class="s">&#39;pubkey&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pubkey</span>
        <span class="c"># Happens on other side of fork().</span>
        <span class="k">if</span> <span class="n">Popen</span><span class="o">.</span><span class="n">thread_is_spawning</span><span class="p">():</span>  <span class="c">#pragma no cover</span>
            <span class="n">kwds</span><span class="p">[</span><span class="s">&#39;authkey&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_authkey</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pubkey</span><span class="p">:</span>
            <span class="c"># Can&#39;t pickle an AuthenticationString.</span>
            <span class="n">kwds</span><span class="p">[</span><span class="s">&#39;authkey&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;PublicKey&#39;</span>

        <span class="n">kwds</span><span class="p">[</span><span class="s">&#39;exposed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exposed_</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">RebuildProxy</span><span class="p">,</span>
                <span class="p">(</span><span class="n">_auto_proxy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serializer</span><span class="p">,</span> <span class="n">kwds</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="register"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.mp_support.register">[docs]</a><span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">manager</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Register class `cls` proxy info with `manager`. The class will be</span>
<span class="sd">    registered under it&#39;s full path, with &#39;.&#39; replaced by &#39;_&#39;.</span>
<span class="sd">    Not typically called by user code.</span>

<span class="sd">    cls: class</span>
<span class="sd">        Class to be registered.</span>

<span class="sd">    manager: :class:`OpenMDAO_Manager`</span>
<span class="sd">        Manager to register with.</span>

<span class="sd">    module: string</span>
<span class="sd">        Module name for registration. Necessary if `cls` might be defined</span>
<span class="sd">        by module &#39;__main__&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">module</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">module</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">__module__</span>
    <span class="n">typeid</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">cls</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
    <span class="n">typeid</span> <span class="o">=</span> <span class="n">typeid</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span> <span class="s">&#39;_&#39;</span><span class="p">)</span>
    <span class="n">exposed</span> <span class="o">=</span> <span class="n">public_methods</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>
    <span class="n">proxytype</span> <span class="o">=</span> <span class="n">_make_proxy_type</span><span class="p">(</span><span class="n">typeid</span><span class="p">,</span> <span class="n">exposed</span><span class="p">)</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">typeid</span><span class="p">,</span> <span class="nb">callable</span><span class="o">=</span><span class="n">cls</span><span class="p">,</span> <span class="n">exposed</span><span class="o">=</span><span class="n">exposed</span><span class="p">,</span> <span class="n">proxytype</span><span class="o">=</span><span class="n">proxytype</span><span class="p">)</span>

</div>
<span class="k">def</span> <span class="nf">_make_proxy_type</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">exposed</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a proxy type whose methods are given by `exposed`.</span>
<span class="sd">    This version supports special attribute access methods.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">exposed</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">exposed</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_PROXY_CACHE</span><span class="p">[(</span><span class="n">name</span><span class="p">,</span> <span class="n">exposed</span><span class="p">)]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="n">dic</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;_instance_names&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s">&#39;_interface_names&#39;</span><span class="p">:</span> <span class="p">{}}</span>

    <span class="k">for</span> <span class="n">meth</span> <span class="ow">in</span> <span class="n">exposed</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">meth</span> <span class="o">==</span> <span class="s">&#39;__is_instance__&#39;</span><span class="p">:</span>
            <span class="c"># Call remote if we don&#39;t have the answer in cache.</span>
            <span class="k">exec</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">def __is_instance__(self, *args, **kwds):</span>
<span class="s">    try:</span>
<span class="s">        return self._instance_names[args[0]]</span>
<span class="s">    except KeyError:</span>
<span class="s">        yes_no = self._callmethod(&#39;__is_instance__&#39;, args, kwds)</span>
<span class="s">        self._instance_names[args[0]] = yes_no</span>
<span class="s">        return yes_no</span>
<span class="s">&quot;&quot;&quot;</span> <span class="ow">in</span> <span class="n">dic</span>

        <span class="k">elif</span> <span class="n">meth</span> <span class="o">==</span> <span class="s">&#39;__has_interface__&#39;</span><span class="p">:</span>
            <span class="c"># Call remote if we don&#39;t have the answer in cache.</span>
            <span class="k">exec</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">def __has_interface__(self, *args, **kwds):</span>
<span class="s">    try:</span>
<span class="s">        return self._interface_names[args[0]]</span>
<span class="s">    except KeyError:</span>
<span class="s">        yes_no = self._callmethod(&#39;__has_interface__&#39;, args, kwds)</span>
<span class="s">        self._interface_names[args[0]] = yes_no</span>
<span class="s">        return yes_no</span>
<span class="s">&quot;&quot;&quot;</span> <span class="ow">in</span> <span class="n">dic</span>

        <span class="k">elif</span> <span class="n">meth</span> <span class="o">==</span> <span class="s">&#39;__getattr__&#39;</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c"># Avoid recursion loop, but must be in &#39;exposed&#39;.</span>

        <span class="k">elif</span> <span class="n">meth</span> <span class="o">==</span> <span class="s">&#39;__getattribute__&#39;</span><span class="p">:</span>
            <span class="c"># Call remote if not private or defined locally (proxied methods).</span>
            <span class="k">exec</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">def __getattr__(self, *args, **kwds):</span>
<span class="s">    if args[0][0] == &#39;_&#39;:</span>
<span class="s">        return object.__getattribute__(self, *args, **kwds)</span>
<span class="s">    try:</span>
<span class="s">        return object.__getattribute__(self, *args, **kwds)</span>
<span class="s">    except AttributeError:</span>
<span class="s">        try:</span>
<span class="s">            return self._callmethod(&#39;__getattribute__&#39;, args, kwds)</span>
<span class="s">        except AttributeError:</span>
<span class="s">            return self._callmethod(&#39;__getattr__&#39;, args, kwds)</span>
<span class="s">&quot;&quot;&quot;</span> <span class="ow">in</span> <span class="n">dic</span>

        <span class="k">elif</span> <span class="n">meth</span> <span class="o">==</span> <span class="s">&#39;__setattr__&#39;</span> <span class="ow">or</span> <span class="n">meth</span> <span class="o">==</span> <span class="s">&#39;__delattr__&#39;</span><span class="p">:</span>
            <span class="c"># Call remote if not private.</span>
            <span class="k">exec</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">def </span><span class="si">%s</span><span class="s">(self, *args, **kwds):</span>
<span class="s">    if args[0][0] == &#39;_&#39;:</span>
<span class="s">        return object.</span><span class="si">%s</span><span class="s">(self, *args, **kwds)</span>
<span class="s">    return self._callmethod(</span><span class="si">%r</span><span class="s">, args, kwds)</span>
<span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">meth</span><span class="p">,</span> <span class="n">meth</span><span class="p">,</span> <span class="n">meth</span><span class="p">)</span> <span class="ow">in</span> <span class="n">dic</span>

        <span class="k">elif</span> <span class="n">meth</span> <span class="o">==</span> <span class="s">&#39;__exit__&#39;</span><span class="p">:</span>
            <span class="c"># Can&#39;t pickle traceback argument.</span>
            <span class="k">exec</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">def __exit__(self, exc_type, exc_value, traceback):</span>
<span class="s">    return self._callmethod(&#39;__exit__&#39;, (exc_type, exc_value, None))</span>
<span class="s">&quot;&quot;&quot;</span> <span class="ow">in</span> <span class="n">dic</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Normal method always calls remote.</span>
            <span class="k">exec</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">def </span><span class="si">%s</span><span class="s">(self, *args, **kwds):</span>
<span class="s">    return self._callmethod(</span><span class="si">%r</span><span class="s">, args, kwds)</span>
<span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">meth</span><span class="p">,</span> <span class="n">meth</span><span class="p">)</span> <span class="ow">in</span> <span class="n">dic</span>

    <span class="n">ProxyType</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">OpenMDAO_Proxy</span><span class="p">,),</span> <span class="n">dic</span><span class="p">)</span>
    <span class="n">ProxyType</span><span class="o">.</span><span class="n">_exposed_</span> <span class="o">=</span> <span class="n">exposed</span>
    <span class="n">_PROXY_CACHE</span><span class="p">[(</span><span class="n">name</span><span class="p">,</span> <span class="n">exposed</span><span class="p">)]</span> <span class="o">=</span> <span class="n">ProxyType</span>
    <span class="k">return</span> <span class="n">ProxyType</span>


<span class="k">def</span> <span class="nf">_auto_proxy</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">serializer</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">authkey</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="n">exposed</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">incref</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">pubkey</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return an auto-proxy for `token`.</span>
<span class="sd">    This version uses :func:`_make_proxy_type`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ProxyType</span> <span class="o">=</span> <span class="n">_make_proxy_type</span><span class="p">(</span><span class="s">&#39;OpenMDAO_AutoProxy[</span><span class="si">%s</span><span class="s">]&#39;</span> <span class="o">%</span> <span class="n">token</span><span class="o">.</span><span class="n">typeid</span><span class="p">,</span>
                                 <span class="n">exposed</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">proxy</span> <span class="o">=</span> <span class="n">ProxyType</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">serializer</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">manager</span><span class="p">,</span> <span class="n">authkey</span><span class="o">=</span><span class="n">authkey</span><span class="p">,</span>
                          <span class="n">incref</span><span class="o">=</span><span class="n">incref</span><span class="p">,</span> <span class="n">pubkey</span><span class="o">=</span><span class="n">pubkey</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s">&#39;Auto proxy creation failed for </span><span class="si">%s</span><span class="s"> at </span><span class="si">%s</span><span class="s">:&#39;</span><span class="p">,</span>
                          <span class="n">token</span><span class="o">.</span><span class="n">typeid</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
        <span class="k">raise</span>
    <span class="n">proxy</span><span class="o">.</span><span class="n">_isauto</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="n">proxy</span>


<span class="k">def</span> <span class="nf">_get_connection</span><span class="p">(</span><span class="n">_client</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">authkey</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get client connection to `address` using `authkey`.</span>
<span class="sd">    Avoids dying on &#39;Interrupted system call&#39;. (Should be in lower layer)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">address</span> <span class="o">=</span> <span class="n">tunnel_address</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">retry</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="n">_client</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">authkey</span><span class="o">=</span><span class="n">authkey</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">exc</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="mi">4</span> <span class="ow">or</span> <span class="n">retry</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">conn</span>

    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;Too many connection attempts&#39;</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<a href="http://openmdao.org">
 <img src="../../../_static/OpenMDAO_Logo_200w_padded.png"
border="0" alt="OpenMDAO Home"/>
</a>

<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
  <li><a href="http://openmdao.org">OpenMDAO Home</a> &raquo;</li>
  
        <li><a href="../../../index.html">OpenMDAO Documentation v0.8.1</a> &raquo;</li>

          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright none.
      Last updated on Aug 26, 2013.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>