
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>openmdao.main.objserverfactory &mdash; OpenMDAO Documentation</title>
    
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.8.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="OpenMDAO Documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
  <li><a href="http://openmdao.org">OpenMDAO Home</a> &raquo;</li>
  
        <li><a href="../../../index.html">OpenMDAO Documentation v0.8.1</a> &raquo;</li>

          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for openmdao.main.objserverfactory</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Support for an OpenMDAO &#39;object service&#39;, a factory that can create servers</span>
<span class="sd">which support various operations such as creating objects, loading models via</span>
<span class="sd">egg files, remote execution, and remote file access.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">atexit</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">optparse</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">pkg_resources</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">current_process</span>

<span class="kn">from</span> <span class="nn">openmdao.main.component</span> <span class="kn">import</span> <span class="n">SimulationRoot</span>
<span class="kn">from</span> <span class="nn">openmdao.main.container</span> <span class="kn">import</span> <span class="n">Container</span>
<span class="kn">from</span> <span class="nn">openmdao.main.factory</span> <span class="kn">import</span> <span class="n">Factory</span>
<span class="kn">from</span> <span class="nn">openmdao.main.factorymanager</span> <span class="kn">import</span> <span class="n">create</span><span class="p">,</span> <span class="n">get_available_types</span><span class="p">,</span> \
                                         <span class="n">get_signature</span>
<span class="kn">from</span> <span class="nn">openmdao.main.file_supp</span> <span class="kn">import</span> <span class="n">RemoteFile</span>
<span class="kn">from</span> <span class="nn">openmdao.main.mp_support</span> <span class="kn">import</span> <span class="n">OpenMDAO_Manager</span><span class="p">,</span> <span class="n">OpenMDAO_Proxy</span><span class="p">,</span> <span class="n">register</span>
<span class="kn">from</span> <span class="nn">openmdao.main.mp_util</span> <span class="kn">import</span> <span class="n">keytype</span><span class="p">,</span> <span class="n">read_allowed_hosts</span><span class="p">,</span> <span class="n">setup_tunnel</span><span class="p">,</span> \
                                  <span class="n">read_server_config</span><span class="p">,</span> <span class="n">write_server_config</span>
<span class="kn">from</span> <span class="nn">openmdao.main.rbac</span> <span class="kn">import</span> <span class="n">get_credentials</span><span class="p">,</span> <span class="n">set_credentials</span><span class="p">,</span> \
                               <span class="n">rbac</span><span class="p">,</span> <span class="n">RoleError</span>
<span class="kn">from</span> <span class="nn">openmdao.main.releaseinfo</span> <span class="kn">import</span> <span class="n">__version__</span>

<span class="kn">from</span> <span class="nn">openmdao.util.filexfer</span> <span class="kn">import</span> <span class="n">pack_zipfile</span><span class="p">,</span> <span class="n">unpack_zipfile</span>
<span class="kn">from</span> <span class="nn">openmdao.util.log</span> <span class="kn">import</span> <span class="n">install_remote_handler</span><span class="p">,</span> <span class="n">remove_remote_handlers</span><span class="p">,</span> \
                              <span class="n">logging_port</span><span class="p">,</span> <span class="n">LOG_DEBUG2</span>
<span class="kn">from</span> <span class="nn">openmdao.util.publickey</span> <span class="kn">import</span> <span class="n">make_private</span><span class="p">,</span> <span class="n">read_authorized_keys</span><span class="p">,</span> \
                                    <span class="n">write_authorized_keys</span><span class="p">,</span> <span class="n">HAVE_PYWIN32</span>
<span class="kn">from</span> <span class="nn">openmdao.util.shellproc</span> <span class="kn">import</span> <span class="n">ShellProc</span><span class="p">,</span> <span class="n">STDOUT</span><span class="p">,</span> <span class="n">DEV_NULL</span>
<span class="kn">from</span> <span class="nn">openmdao.util.fileutil</span> <span class="kn">import</span> <span class="n">onerror</span>

<span class="n">_PROXIES</span> <span class="o">=</span> <span class="p">{}</span>


<div class="viewcode-block" id="ObjServerFactory"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.objserverfactory.ObjServerFactory">[docs]</a><span class="k">class</span> <span class="nc">ObjServerFactory</span><span class="p">(</span><span class="n">Factory</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An :class:`ObjServerFactory` creates :class:`ObjServers` and objects</span>
<span class="sd">    within those servers.</span>

<span class="sd">    name: string</span>
<span class="sd">        Name of factory; used in log messages, etc.</span>

<span class="sd">    authkey: string</span>
<span class="sd">        Passed to created :class:`ObjServer` servers.</span>

<span class="sd">    allow_shell: bool</span>
<span class="sd">        Passed to created :class:`ObjServer` servers.</span>

<span class="sd">    allowed_types: list(string)</span>
<span class="sd">        Passed to created :class:`ObjServer` servers.</span>

<span class="sd">    address: tuple or string</span>
<span class="sd">        A :mod:`multiprocessing` address specifying an Internet address or</span>
<span class="sd">        a pipe (default).  Created :class:`ObjServer` servers will use the</span>
<span class="sd">        same form of address.</span>

<span class="sd">    The environment variable ``OPENMDAO_KEEPDIRS`` can be used to avoid</span>
<span class="sd">    having server directory trees removed when servers are shut down.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># These are used to propagate selections from main().</span>
    <span class="c"># There isn&#39;t a good way to propagate them through a manager.</span>
    <span class="n">_address</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">_allow_shell</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">_allowed_types</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">_allow_tunneling</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;ObjServerFactory&#39;</span><span class="p">,</span> <span class="n">authkey</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">allow_shell</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">allowed_types</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ObjServerFactory</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_authkey</span> <span class="o">=</span> <span class="n">authkey</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_address</span> <span class="o">=</span> <span class="n">address</span> <span class="ow">or</span> <span class="n">ObjServerFactory</span><span class="o">.</span><span class="n">_address</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_allow_shell</span> <span class="o">=</span> <span class="n">allow_shell</span> <span class="ow">or</span> <span class="n">ObjServerFactory</span><span class="o">.</span><span class="n">_allow_shell</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_allowed_types</span> <span class="o">=</span> <span class="n">allowed_types</span> <span class="ow">or</span> <span class="n">ObjServerFactory</span><span class="o">.</span><span class="n">_allowed_types</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_managers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;PID: </span><span class="si">%d</span><span class="s">, </span><span class="si">%r</span><span class="s">, allow_shell </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span>
                          <span class="n">keytype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_authkey</span><span class="p">),</span> <span class="n">allow_shell</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">node</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">__version__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manager_class</span> <span class="o">=</span> <span class="n">_ServerManager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_classname</span> <span class="o">=</span> <span class="s">&#39;openmdao_main_objserverfactory_ObjServer&#39;</span>

    <span class="nd">@rbac</span><span class="p">(</span><span class="s">&#39;*&#39;</span><span class="p">,</span> <span class="n">proxy_types</span><span class="o">=</span><span class="p">[</span><span class="nb">object</span><span class="p">])</span>  <span class="c"># ResourceAllocationManager import loop.</span>
<div class="viewcode-block" id="ObjServerFactory.get_ram"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.objserverfactory.ObjServerFactory.get_ram">[docs]</a>    <span class="k">def</span> <span class="nf">get_ram</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the :class:`ResourceAllocationManager` instance.</span>
<span class="sd">        Used by :meth:`ResourceAllocationManager.add_remotes`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;get_ram&#39;</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">openmdao.main.resource</span> <span class="kn">import</span> <span class="n">ResourceAllocationManager</span>
        <span class="k">return</span> <span class="n">ResourceAllocationManager</span><span class="o">.</span><span class="n">_get_instance</span><span class="p">()</span>
</div>
    <span class="nd">@rbac</span><span class="p">(</span><span class="s">&#39;*&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="ObjServerFactory.echo"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.objserverfactory.ObjServerFactory.echo">[docs]</a>    <span class="k">def</span> <span class="nf">echo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Simply return the arguments. This can be useful for latency/thruput</span>
<span class="sd">        masurements, connectivity testing, firewall keepalives, etc.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">args</span>
</div>
    <span class="nd">@rbac</span><span class="p">((</span><span class="s">&#39;owner&#39;</span><span class="p">,</span> <span class="s">&#39;user&#39;</span><span class="p">))</span>
<div class="viewcode-block" id="ObjServerFactory.release"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.objserverfactory.ObjServerFactory.release">[docs]</a>    <span class="k">def</span> <span class="nf">release</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Shut-down :class:`ObjServer` `server`.</span>

<span class="sd">        server: :class:`ObjServer`</span>
<span class="sd">            Server to be shut down.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">address</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">_token</span><span class="o">.</span><span class="n">address</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">address</span> <span class="o">=</span> <span class="s">&#39;not-a-proxy&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;release </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">server</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;        at </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">manager</span><span class="p">,</span> <span class="n">root_dir</span><span class="p">,</span> <span class="n">owner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_managers</span><span class="p">[</span><span class="n">server</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c"># Not identical to any of our proxies.</span>
            <span class="c"># Could still be a reference to the same remote object.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">server_host</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">host</span>
                <span class="n">server_pid</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">pid</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;release: can&#39;t identify server at </span><span class="si">%r</span><span class="s">&quot;</span><span class="p">,</span>
                                   <span class="n">address</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;can&#39;t identify server at </span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">address</span><span class="p">,))</span>

            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_managers</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">host</span> <span class="o">==</span> <span class="n">server_host</span> <span class="ow">and</span> <span class="n">key</span><span class="o">.</span><span class="n">pid</span> <span class="o">==</span> <span class="n">server_pid</span><span class="p">:</span>
                    <span class="n">manager</span><span class="p">,</span> <span class="n">root_dir</span><span class="p">,</span> <span class="n">owner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_managers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    <span class="n">server</span> <span class="o">=</span> <span class="n">key</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;release: server </span><span class="si">%r</span><span class="s"> not found&#39;</span><span class="p">,</span> <span class="n">server</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_managers</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;    </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;    at </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">.</span><span class="n">_token</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;server </span><span class="si">%r</span><span class="s"> not found&#39;</span> <span class="o">%</span> <span class="n">server</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">get_credentials</span><span class="p">()</span><span class="o">.</span><span class="n">user</span> <span class="o">!=</span> <span class="n">owner</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RoleError</span><span class="p">(</span><span class="s">&#39;only the owner can release&#39;</span><span class="p">)</span>

        <span class="n">manager</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        <span class="n">server</span><span class="o">.</span><span class="n">_close</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_managers</span><span class="p">[</span><span class="n">server</span><span class="p">]</span>
        <span class="n">keep_dirs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;OPENMDAO_KEEPDIRS&#39;</span><span class="p">,</span> <span class="s">&#39;0&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">keep_dirs</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">root_dir</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">onerror</span><span class="o">=</span><span class="n">onerror</span><span class="p">)</span>
</div>
    <span class="nd">@rbac</span><span class="p">(</span><span class="s">&#39;owner&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="ObjServerFactory.cleanup"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.objserverfactory.ObjServerFactory.cleanup">[docs]</a>    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Shut-down all remaining :class:`ObjServers`. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;cleanup&#39;</span><span class="p">)</span>
        <span class="n">cleanup_creds</span> <span class="o">=</span> <span class="n">get_credentials</span><span class="p">()</span>
        <span class="n">servers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_managers</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">server</span> <span class="ow">in</span> <span class="n">servers</span><span class="p">:</span>
            <span class="c"># Cleanup overrides release() &#39;owner&#39; protection.</span>
            <span class="n">set_credentials</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_managers</span><span class="p">[</span><span class="n">server</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">set_credentials</span><span class="p">(</span><span class="n">cleanup_creds</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_managers</span> <span class="o">=</span> <span class="p">{}</span>
</div>
    <span class="nd">@rbac</span><span class="p">(</span><span class="s">&#39;*&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="ObjServerFactory.get_available_types"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.objserverfactory.ObjServerFactory.get_available_types">[docs]</a>    <span class="k">def</span> <span class="nf">get_available_types</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a set of tuples of the form ``(typename, metadata)``,</span>
<span class="sd">        one for each available plugin type in the given entry point groups.</span>
<span class="sd">        If groups is *None,* return the set for all openmdao entry point groups.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;get_available_types </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">groups</span><span class="p">)</span>
        <span class="n">types</span> <span class="o">=</span> <span class="n">get_available_types</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">typname</span><span class="p">,</span> <span class="n">version</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">LOG_DEBUG2</span><span class="p">,</span> <span class="s">&#39;    </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">typname</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">types</span>
</div>
    <span class="nd">@rbac</span><span class="p">((</span><span class="s">&#39;owner&#39;</span><span class="p">,</span> <span class="s">&#39;user&#39;</span><span class="p">))</span>
<div class="viewcode-block" id="ObjServerFactory.get_signature"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.objserverfactory.ObjServerFactory.get_signature">[docs]</a>    <span class="k">def</span> <span class="nf">get_signature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">typname</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return constructor argument signature for *typname,* using the</span>
<span class="sd">        specified package version. The return value is a dictionary.</span>

<span class="sd">        typname: string</span>
<span class="sd">            Type of object to constructor to inspect.</span>

<span class="sd">        version: string or None</span>
<span class="sd">            Version of `typname` to create.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;get_signature typname </span><span class="si">%s</span><span class="s"> version </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span>
                           <span class="n">typname</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>
        <span class="n">signature</span> <span class="o">=</span> <span class="n">get_signature</span><span class="p">(</span><span class="n">typname</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">LOG_DEBUG2</span><span class="p">,</span> <span class="s">&#39;    </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">signature</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">signature</span>
</div>
    <span class="nd">@rbac</span><span class="p">((</span><span class="s">&#39;owner&#39;</span><span class="p">,</span> <span class="s">&#39;user&#39;</span><span class="p">))</span>
<div class="viewcode-block" id="ObjServerFactory.create"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.objserverfactory.ObjServerFactory.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">typname</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">server</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">res_desc</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">ctor_args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new `typname` object in `server` or a new</span>
<span class="sd">        :class:`ObjectServer`.  Returns a proxy for for the new object.</span>
<span class="sd">        Starts servers in a subdirectory of the current directory.</span>

<span class="sd">        typname: string</span>
<span class="sd">            Type of object to create. If null, then a proxy for the new</span>
<span class="sd">            :class:`ObjServer` is returned.</span>

<span class="sd">        version: string or None</span>
<span class="sd">            Version of `typname` to create.</span>

<span class="sd">        server: proxy</span>
<span class="sd">            :class:`ObjServer` on which to create `typname`.</span>
<span class="sd">            If none, then a new server is created.</span>

<span class="sd">        res_desc: dict or None</span>
<span class="sd">            Required resources. Currently not used.</span>

<span class="sd">        ctor_args: dict</span>
<span class="sd">            Other constructor arguments.</span>
<span class="sd">            If `name` or `allowed_users` are specified, they are used when</span>
<span class="sd">            creating the :class:`ObjServer`. If no `allowed_users` are</span>
<span class="sd">            specified, the server is private to the current user.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;create typname </span><span class="si">%r</span><span class="s">, version </span><span class="si">%r</span><span class="s"> server </span><span class="si">%s</span><span class="s">,&#39;</span>
                          <span class="s">&#39; res_desc </span><span class="si">%s</span><span class="s">, args </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">typname</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span>
                          <span class="n">res_desc</span><span class="p">,</span> <span class="n">ctor_args</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">server</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">ctor_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;Server_</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_managers</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

            <span class="n">allowed_users</span> <span class="o">=</span> <span class="n">ctor_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;allowed_users&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">allowed_users</span><span class="p">:</span>
                <span class="n">credentials</span> <span class="o">=</span> <span class="n">get_credentials</span><span class="p">()</span>
                <span class="n">allowed_users</span> <span class="o">=</span> <span class="p">{</span><span class="n">credentials</span><span class="o">.</span><span class="n">user</span><span class="p">:</span> <span class="n">credentials</span><span class="o">.</span><span class="n">public_key</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">ctor_args</span><span class="p">[</span><span class="s">&#39;allowed_users&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_address</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> \
               <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_address</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">or</span> \
               <span class="bp">self</span><span class="o">.</span><span class="n">_allow_tunneling</span><span class="p">:</span>
                <span class="c"># Local access only via pipe if factory accessed by pipe</span>
                <span class="c"># or factory is accessed via tunnel.</span>
                <span class="n">address</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># Network access via same IP as factory, system-selected port.</span>
                <span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_address</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>

            <span class="n">manager</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager_class</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_authkey</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                                         <span class="n">allowed_users</span><span class="o">=</span><span class="n">allowed_users</span><span class="p">)</span>
            <span class="n">root_dir</span> <span class="o">=</span> <span class="n">name</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">while</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">root_dir</span><span class="p">):</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">root_dir</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">_</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">root_dir</span><span class="p">)</span>

            <span class="c"># On Windows, when running the full test suite under Nose,</span>
            <span class="c"># starting the process starts a new Nose test session, which</span>
            <span class="c"># will eventually get here and start a new Nose session, which...</span>
            <span class="n">orig_main</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&#39;win32&#39;</span><span class="p">:</span>  <span class="c">#pragma no cover</span>
                <span class="n">scripts</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;openmdao-script.py&#39;</span><span class="p">,</span> <span class="s">&#39;openmdao_test-script.py&#39;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">main_file</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s">&#39;__main__&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">__file__</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">main_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">scripts</span><span class="p">):</span>
                        <span class="n">orig_main</span> <span class="o">=</span> <span class="n">main_file</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s">&#39;__main__&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">__file__</span> <span class="o">=</span> \
                            <span class="n">pkg_resources</span><span class="o">.</span><span class="n">resource_filename</span><span class="p">(</span><span class="s">&#39;openmdao.main&#39;</span><span class="p">,</span>
                                                            <span class="s">&#39;objserverfactory.py&#39;</span><span class="p">)</span>
            <span class="n">owner</span> <span class="o">=</span> <span class="n">get_credentials</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">LOG_DEBUG2</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> starting server </span><span class="si">%r</span><span class="s"> in dir </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span>
                             <span class="n">owner</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">root_dir</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">manager</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">cwd</span><span class="o">=</span><span class="n">root_dir</span><span class="p">,</span>
                              <span class="n">log_level</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">getEffectiveLevel</span><span class="p">())</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">orig_main</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>  <span class="c">#pragma no cover</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s">&#39;__main__&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">__file__</span> <span class="o">=</span> <span class="n">orig_main</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;new server </span><span class="si">%r</span><span class="s"> for </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">owner</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;    in dir </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">root_dir</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;    listening on </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">manager</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
            <span class="n">server_class</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">manager</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_classname</span><span class="p">)</span>
            <span class="n">server</span> <span class="o">=</span> <span class="n">server_class</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">allow_shell</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_allow_shell</span><span class="p">,</span>
                                  <span class="n">allowed_types</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_allowed_types</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_managers</span><span class="p">[</span><span class="n">server</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">manager</span><span class="p">,</span> <span class="n">root_dir</span><span class="p">,</span> <span class="n">owner</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">typname</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">typname</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">res_desc</span><span class="p">,</span> <span class="o">**</span><span class="n">ctor_args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">server</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">LOG_DEBUG2</span><span class="p">,</span> <span class="s">&#39;create returning </span><span class="si">%r</span><span class="s"> at </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span>
                         <span class="n">obj</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">_token</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span>

</div></div>
<span class="k">class</span> <span class="nc">_FactoryManager</span><span class="p">(</span><span class="n">OpenMDAO_Manager</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A :class:`multiprocessing.Manager` which manages :class:`ObjServerFactory`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>

<span class="n">register</span><span class="p">(</span><span class="n">ObjServerFactory</span><span class="p">,</span> <span class="n">_FactoryManager</span><span class="p">,</span> <span class="s">&#39;openmdao.main.objserverfactory&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="ObjServer"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.objserverfactory.ObjServer">[docs]</a><span class="k">class</span> <span class="nc">ObjServer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An object which knows how to create other objects, load a model, etc.</span>
<span class="sd">    All remote file accesses must be within the tree rooted in the current</span>
<span class="sd">    directory at startup.</span>

<span class="sd">    name: string</span>
<span class="sd">        Name of server; used in log messages, etc.</span>

<span class="sd">    allow_shell: bool</span>
<span class="sd">        If True, :meth:`execute_command` and :meth:`load_model` are allowed.</span>
<span class="sd">        Use with caution!</span>

<span class="sd">    allowed_types: list(string)</span>
<span class="sd">        Names of types which may be created. If None, then allow types listed</span>
<span class="sd">        by :meth:`factorymanager.get_available_types`. If empty, no types are</span>
<span class="sd">        allowed.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">allow_shell</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">allowed_types</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_allow_shell</span> <span class="o">=</span> <span class="n">allow_shell</span>
        <span class="k">if</span> <span class="n">allowed_types</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">allowed_types</span> <span class="o">=</span> <span class="p">[</span><span class="n">typname</span> <span class="k">for</span> <span class="n">typname</span><span class="p">,</span> <span class="n">version</span>
                                      <span class="ow">in</span> <span class="n">get_available_types</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_allowed_types</span> <span class="o">=</span> <span class="n">allowed_types</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">node</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="ow">or</span> <span class="p">(</span><span class="s">&#39;sim-</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">__version__</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_root_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;PID: </span><span class="si">%d</span><span class="s">, allow_shell </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span>
                          <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allow_shell</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%r</span><span class="s"> PID: </span><span class="si">%d</span><span class="s">, allow_shell </span><span class="si">%s</span><span class="s">&#39;</span> \
              <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">_allow_shell</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="n">SimulationRoot</span><span class="o">.</span><span class="n">chroot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tlo</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c"># Ensure Traits Array support is initialized. The code contains</span>
        <span class="c"># globals for numpy symbols that are initialized within</span>
        <span class="c"># AbstractArray.__init__() which won&#39;t be executed if we simply</span>
        <span class="c"># load up egg state (or don&#39;t do a real fork, like Windows).</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">numpy</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">traits.trait_numeric</span> <span class="kn">import</span> <span class="n">AbstractArray</span>
            <span class="n">dummy</span> <span class="o">=</span> <span class="n">AbstractArray</span><span class="p">()</span>

    <span class="nd">@rbac</span><span class="p">((</span><span class="s">&#39;owner&#39;</span><span class="p">,</span> <span class="s">&#39;user&#39;</span><span class="p">))</span>
<div class="viewcode-block" id="ObjServer.set_log_level"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.objserverfactory.ObjServer.set_log_level">[docs]</a>    <span class="k">def</span> <span class="nf">set_log_level</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set logging level to `level`. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;log_level </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
</div>
    <span class="nd">@rbac</span><span class="p">(</span><span class="s">&#39;*&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="ObjServer.echo"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.objserverfactory.ObjServer.echo">[docs]</a>    <span class="k">def</span> <span class="nf">echo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Simply return the arguments. This can be useful for latency/thruput</span>
<span class="sd">        masurements, connectivity testing, firewall keepalives, etc.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">args</span>
</div>
    <span class="nd">@rbac</span><span class="p">(</span><span class="s">&#39;owner&#39;</span><span class="p">,</span> <span class="n">proxy_types</span><span class="o">=</span><span class="p">[</span><span class="nb">object</span><span class="p">])</span>
<div class="viewcode-block" id="ObjServer.create"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.objserverfactory.ObjServer.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">typname</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">server</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">res_desc</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">ctor_args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If *typname* is an allowed type, returns an object of type *typname,*</span>
<span class="sd">        using the specified package version, server location, and resource</span>
<span class="sd">        description. All arguments are passed to :meth:`factorymanager.create`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;create typname </span><span class="si">%r</span><span class="s">, version </span><span class="si">%r</span><span class="s"> server </span><span class="si">%s</span><span class="s">,&#39;</span>
                           <span class="s">&#39; res_desc </span><span class="si">%s</span><span class="s">, args </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">typname</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span>
                           <span class="n">res_desc</span><span class="p">,</span> <span class="n">ctor_args</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">typname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allowed_types</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span><span class="n">typname</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">res_desc</span><span class="p">,</span> <span class="o">**</span><span class="n">ctor_args</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">LOG_DEBUG2</span><span class="p">,</span> <span class="s">&#39;    returning </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">obj</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%r</span><span class="s"> is not an allowed type&#39;</span> <span class="o">%</span> <span class="n">typname</span><span class="p">)</span>
</div>
    <span class="nd">@rbac</span><span class="p">(</span><span class="s">&#39;owner&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="ObjServer.execute_command"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.objserverfactory.ObjServer.execute_command">[docs]</a>    <span class="k">def</span> <span class="nf">execute_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_desc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run command described by `resource_desc` in a subprocess if this</span>
<span class="sd">        server&#39;s `allow_shell` attribute is True.</span>

<span class="sd">        resource_desc: dict</span>
<span class="sd">            Contains job description.</span>

<span class="sd">        The current environment, along with any &#39;job_environment&#39; specification,</span>
<span class="sd">        is in effect while running &#39;remote_command&#39;.</span>

<span class="sd">        If &#39;input_path&#39; is not specified, ``/dev/null`` or ``nul:`` is used.</span>
<span class="sd">        If &#39;output_path&#39; is not specified, ``&lt;remote_command&gt;.stdout`` is used.</span>
<span class="sd">        If neither &#39;error_path&#39; nor &#39;join_files&#39; are specified,</span>
<span class="sd">        ``&lt;remote_command&gt;.stderr`` is used.</span>

<span class="sd">        If specified in the &#39;resource_limits&#39; dictionary, &#39;wallclock_time&#39; is</span>
<span class="sd">        used as a timeout.</span>

<span class="sd">        All other queuing resource keys are ignored.</span>

<span class="sd">        The ``HOME_DIRECTORY`` and ``WORKING_DIRECTORY`` placeholders are</span>
<span class="sd">        ignored.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">job_name</span> <span class="o">=</span> <span class="n">resource_desc</span><span class="p">[</span><span class="s">&#39;job_name&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">job_name</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

        <span class="n">command</span> <span class="o">=</span> <span class="n">resource_desc</span><span class="p">[</span><span class="s">&#39;remote_command&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_path</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="s">&#39;execute_command&#39;</span><span class="p">)</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="n">command</span><span class="p">]</span>
        <span class="k">if</span> <span class="s">&#39;args&#39;</span> <span class="ow">in</span> <span class="n">resource_desc</span><span class="p">:</span>
            <span class="n">command</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">resource_desc</span><span class="p">[</span><span class="s">&#39;args&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;execute_command </span><span class="si">%s</span><span class="s"> </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">job_name</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allow_shell</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;attempt to execute </span><span class="si">%r</span><span class="s"> by </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span>
                               <span class="n">get_credentials</span><span class="p">()</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;shell access is not allowed by this server&#39;</span><span class="p">)</span>

        <span class="n">env_vars</span> <span class="o">=</span> <span class="n">resource_desc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;job_environment&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">stdin</span> <span class="o">=</span> <span class="n">resource_desc</span><span class="p">[</span><span class="s">&#39;input_path&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_path</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="s">&#39;execute_command&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">stdin</span> <span class="o">=</span> <span class="n">DEV_NULL</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">stdout</span> <span class="o">=</span> <span class="n">resource_desc</span><span class="p">[</span><span class="s">&#39;output_path&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_path</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&#39;execute_command&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">stdout</span> <span class="o">=</span> <span class="n">base</span><span class="o">+</span><span class="s">&#39;.stdout&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">stderr</span> <span class="o">=</span> <span class="n">resource_desc</span><span class="p">[</span><span class="s">&#39;error_path&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_path</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#39;execute_command&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">join_files</span> <span class="o">=</span> <span class="n">resource_desc</span><span class="p">[</span><span class="s">&#39;join_files&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">stderr</span> <span class="o">=</span> <span class="n">base</span><span class="o">+</span><span class="s">&#39;.stderr&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stderr</span> <span class="o">=</span> <span class="n">STDOUT</span> <span class="k">if</span> <span class="n">join_files</span> <span class="k">else</span> <span class="n">base</span><span class="o">+</span><span class="s">&#39;.stderr&#39;</span>

        <span class="n">limits</span> <span class="o">=</span> <span class="n">resource_desc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;resource_limits&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">timeout</span> <span class="o">=</span> <span class="n">limits</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;wallclock_time&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">poll_delay</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">process</span> <span class="o">=</span> <span class="n">ShellProc</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">env_vars</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;exception creating process: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;    PID = </span><span class="si">%d</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">process</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
        <span class="n">return_code</span><span class="p">,</span> <span class="n">error_msg</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">poll_delay</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;    returning </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">return_code</span><span class="p">,</span> <span class="n">error_msg</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">return_code</span><span class="p">,</span> <span class="n">error_msg</span><span class="p">)</span>
</div>
    <span class="nd">@rbac</span><span class="p">(</span><span class="s">&#39;owner&#39;</span><span class="p">,</span> <span class="n">proxy_types</span><span class="o">=</span><span class="p">[</span><span class="n">Container</span><span class="p">])</span>
<div class="viewcode-block" id="ObjServer.load_model"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.objserverfactory.ObjServer.load_model">[docs]</a>    <span class="k">def</span> <span class="nf">load_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">egg_filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load model from egg and return top-level object if this server&#39;s</span>
<span class="sd">        `allow_shell` attribute is True.</span>

<span class="sd">        egg_filename: string</span>
<span class="sd">            Filename of egg to be loaded.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;load_model </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">egg_filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allow_shell</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;attempt to load </span><span class="si">%r</span><span class="s"> by </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">egg_filename</span><span class="p">,</span>
                               <span class="n">get_credentials</span><span class="p">()</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;shell access is not allowed by this server&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_path</span><span class="p">(</span><span class="n">egg_filename</span><span class="p">,</span> <span class="s">&#39;load_model&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tlo</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tlo</span><span class="o">.</span><span class="n">pre_delete</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tlo</span> <span class="o">=</span> <span class="n">Container</span><span class="o">.</span><span class="n">load_from_eggfile</span><span class="p">(</span><span class="n">egg_filename</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tlo</span>
</div>
    <span class="nd">@rbac</span><span class="p">(</span><span class="s">&#39;owner&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="ObjServer.pack_zipfile"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.objserverfactory.ObjServer.pack_zipfile">[docs]</a>    <span class="k">def</span> <span class="nf">pack_zipfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patterns</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create ZipFile of files matching `patterns` if `filename` is legal.</span>

<span class="sd">        patterns: list</span>
<span class="sd">            List of :mod:`glob`-style patterns.</span>

<span class="sd">        filename: string</span>
<span class="sd">            Name of ZipFile to create.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;pack_zipfile </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_path</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;pack_zipfile&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pack_zipfile</span><span class="p">(</span><span class="n">patterns</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">)</span>
</div>
    <span class="nd">@rbac</span><span class="p">(</span><span class="s">&#39;owner&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="ObjServer.unpack_zipfile"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.objserverfactory.ObjServer.unpack_zipfile">[docs]</a>    <span class="k">def</span> <span class="nf">unpack_zipfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">textfiles</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Unpack ZipFile `filename` if `filename` is legal.</span>

<span class="sd">        filename: string</span>
<span class="sd">            Name of ZipFile to unpack.</span>

<span class="sd">        textfiles: list</span>
<span class="sd">            List of :mod:`fnmatch` style patterns specifying which unpacked</span>
<span class="sd">            files are text files possibly needing newline translation. If not</span>
<span class="sd">            supplied, the first 4KB of each is scanned for a zero byte. If none</span>
<span class="sd">            is found, then the file is assumed to be a text file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;unpack_zipfile </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_path</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;unpack_zipfile&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">unpack_zipfile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">,</span> <span class="n">textfiles</span><span class="p">)</span>
</div>
    <span class="nd">@rbac</span><span class="p">(</span><span class="s">&#39;owner&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="ObjServer.chmod"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.objserverfactory.ObjServer.chmod">[docs]</a>    <span class="k">def</span> <span class="nf">chmod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns ``os.chmod(path, mode)`` if `path` is legal.</span>

<span class="sd">        path: string</span>
<span class="sd">            Path to file to modify.</span>

<span class="sd">        mode: int</span>
<span class="sd">            New mode bits (permissions).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;chmod </span><span class="si">%r</span><span class="s"> </span><span class="si">%o</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_path</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&#39;chmod&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;chmod </span><span class="si">%r</span><span class="s"> </span><span class="si">%o</span><span class="s"> in </span><span class="si">%s</span><span class="s"> failed </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span>
                               <span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">exc</span><span class="p">)</span>
            <span class="k">raise</span>
</div>
    <span class="nd">@rbac</span><span class="p">(</span><span class="s">&#39;owner&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="ObjServer.isdir"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.objserverfactory.ObjServer.isdir">[docs]</a>    <span class="k">def</span> <span class="nf">isdir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns ``os.path.isdir(path)`` if `path` is legal.</span>

<span class="sd">        path: string</span>
<span class="sd">            Path to check.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;isdir </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_path</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&#39;isdir&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;isdir </span><span class="si">%r</span><span class="s"> in </span><span class="si">%s</span><span class="s"> failed </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span>
                               <span class="n">path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">exc</span><span class="p">)</span>
            <span class="k">raise</span>
</div>
    <span class="nd">@rbac</span><span class="p">(</span><span class="s">&#39;owner&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="ObjServer.listdir"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.objserverfactory.ObjServer.listdir">[docs]</a>    <span class="k">def</span> <span class="nf">listdir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns ``os.listdir(path)`` if `path` is legal.</span>

<span class="sd">        path: string</span>
<span class="sd">            Path to directory to list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;listdir </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_path</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&#39;listdir&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;listdir </span><span class="si">%r</span><span class="s"> in </span><span class="si">%s</span><span class="s"> failed </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span>
                               <span class="n">path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">exc</span><span class="p">)</span>
            <span class="k">raise</span>
</div>
    <span class="nd">@rbac</span><span class="p">(</span><span class="s">&#39;owner&#39;</span><span class="p">,</span> <span class="n">proxy_types</span><span class="o">=</span><span class="p">[</span><span class="n">RemoteFile</span><span class="p">])</span>
<div class="viewcode-block" id="ObjServer.open"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.objserverfactory.ObjServer.open">[docs]</a>    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;r&#39;</span><span class="p">,</span> <span class="n">bufsize</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns ``open(filename, mode, bufsize)`` if `filename` is legal.</span>

<span class="sd">        filename: string</span>
<span class="sd">            Name of file to open.</span>

<span class="sd">        mode: string</span>
<span class="sd">            Access mode.</span>

<span class="sd">        bufsize: int</span>
<span class="sd">            Size of buffer to use.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;open </span><span class="si">%r</span><span class="s"> </span><span class="si">%r</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">bufsize</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_path</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;open&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">RemoteFile</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">bufsize</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;open </span><span class="si">%r</span><span class="s"> </span><span class="si">%r</span><span class="s"> </span><span class="si">%s</span><span class="s"> in </span><span class="si">%s</span><span class="s"> failed </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span>
                               <span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">bufsize</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">exc</span><span class="p">)</span>
            <span class="k">raise</span>
</div>
    <span class="nd">@rbac</span><span class="p">(</span><span class="s">&#39;owner&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="ObjServer.remove"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.objserverfactory.ObjServer.remove">[docs]</a>    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove `path` if `path` is legal.</span>

<span class="sd">        path: string</span>
<span class="sd">            Path to file to remove.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;remove </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_path</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&#39;remove&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;remove </span><span class="si">%r</span><span class="s"> in </span><span class="si">%s</span><span class="s"> failed </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span>
                               <span class="n">path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">exc</span><span class="p">)</span>
            <span class="k">raise</span>
</div>
    <span class="nd">@rbac</span><span class="p">(</span><span class="s">&#39;owner&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="ObjServer.stat"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.objserverfactory.ObjServer.stat">[docs]</a>    <span class="k">def</span> <span class="nf">stat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns ``os.stat(path)`` if `path` is legal.</span>

<span class="sd">        path: string</span>
<span class="sd">            Path to file to interrogate.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;stat </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_path</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&#39;stat&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;stat </span><span class="si">%r</span><span class="s"> in </span><span class="si">%s</span><span class="s"> failed </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span>
                               <span class="n">path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">exc</span><span class="p">)</span>
            <span class="k">raise</span>
</div>
    <span class="k">def</span> <span class="nf">_check_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">operation</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Check if path is allowed to be used. &quot;&quot;&quot;</span>
        <span class="n">abspath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">abspath</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root_dir</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;Can&#39;t </span><span class="si">%s</span><span class="s"> </span><span class="si">%r</span><span class="s">, not within root </span><span class="si">%s</span><span class="s">&quot;</span>
                               <span class="o">%</span> <span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root_dir</span><span class="p">))</span>

</div>
<span class="k">class</span> <span class="nc">_ServerManager</span><span class="p">(</span><span class="n">OpenMDAO_Manager</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A :class:`multiprocessing.Manager` which manages :class:`ObjServer`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>

<span class="n">register</span><span class="p">(</span><span class="n">ObjServer</span><span class="p">,</span> <span class="n">_ServerManager</span><span class="p">,</span> <span class="s">&#39;openmdao.main.objserverfactory&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="connect_to_server"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.objserverfactory.connect_to_server">[docs]</a><span class="k">def</span> <span class="nf">connect_to_server</span><span class="p">(</span><span class="n">config_filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Connects to the the server specified by `config_filename` and returns a</span>
<span class="sd">    (shared) proxy for the associated :class:`ObjServerFactory`.</span>

<span class="sd">    config_filename: string:</span>
<span class="sd">        Name of server configuration file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">read_server_config</span><span class="p">(</span><span class="n">config_filename</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">connect</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="s">&#39;address&#39;</span><span class="p">],</span> <span class="n">cfg</span><span class="p">[</span><span class="s">&#39;port&#39;</span><span class="p">],</span> <span class="n">cfg</span><span class="p">[</span><span class="s">&#39;tunnel&#39;</span><span class="p">],</span>
                   <span class="n">pubkey</span><span class="o">=</span><span class="n">cfg</span><span class="p">[</span><span class="s">&#39;key&#39;</span><span class="p">],</span> <span class="n">logfile</span><span class="o">=</span><span class="n">cfg</span><span class="p">[</span><span class="s">&#39;logfile&#39;</span><span class="p">])</span>

</div>
<div class="viewcode-block" id="connect"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.objserverfactory.connect">[docs]</a><span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">tunnel</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">authkey</span><span class="o">=</span><span class="s">&#39;PublicKey&#39;</span><span class="p">,</span> <span class="n">pubkey</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">logfile</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Connects to the server at `address` and `port` using `key` and returns</span>
<span class="sd">    a (shared) proxy for the associated :class:`ObjServerFactory`.</span>

<span class="sd">    address: string</span>
<span class="sd">        IP address for server or pipe filename.</span>

<span class="sd">    port: int</span>
<span class="sd">        Server port.  If &lt; 0, `address` is a pipe filename.</span>

<span class="sd">    tunnel: bool</span>
<span class="sd">        Connect via SSH tunnel.</span>

<span class="sd">    authkey:</span>
<span class="sd">        Server authorization key.</span>

<span class="sd">    pubkey:</span>
<span class="sd">        Server public key; required if `authkey` is &#39;PublicKey&#39;.</span>

<span class="sd">    logfile:</span>
<span class="sd">        Location of server&#39;s log file, if known.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">port</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">address</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_PROXIES</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="c"># Requires ssh setup.</span>
        <span class="k">if</span> <span class="n">tunnel</span><span class="p">:</span>  <span class="c"># pragma no cover</span>
            <span class="n">location</span><span class="p">,</span> <span class="n">cleanup</span> <span class="o">=</span> <span class="n">setup_tunnel</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
            <span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="o">*</span><span class="n">cleanup</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">location</span> <span class="o">=</span> <span class="n">key</span>
        <span class="n">via</span> <span class="o">=</span> <span class="s">&#39; (via tunnel)&#39;</span> <span class="k">if</span> <span class="n">tunnel</span> <span class="k">else</span> <span class="s">&#39;&#39;</span>
        <span class="n">log</span> <span class="o">=</span> <span class="s">&#39; at </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">logfile</span> <span class="k">if</span> <span class="n">logfile</span> <span class="k">else</span> <span class="s">&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">OpenMDAO_Proxy</span><span class="o">.</span><span class="n">manager_is_alive</span><span class="p">(</span><span class="n">location</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;Can&#39;t connect to server at </span><span class="si">%s</span><span class="s">:</span><span class="si">%s%s</span><span class="s">. It appears&quot;</span>
                               <span class="s">&quot; to be offline. Please check the server log</span><span class="si">%s</span><span class="s">.&quot;</span>
                               <span class="o">%</span> <span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">via</span><span class="p">,</span> <span class="n">log</span><span class="p">))</span>

        <span class="n">mgr</span> <span class="o">=</span> <span class="n">_FactoryManager</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">authkey</span><span class="p">,</span> <span class="n">pubkey</span><span class="o">=</span><span class="n">pubkey</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mgr</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">EOFError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;Can&#39;t connect to server at </span><span class="si">%s</span><span class="s">:</span><span class="si">%s%s</span><span class="s">. It appears&quot;</span>
                               <span class="s">&quot; to be rejecting the connection. Please check&quot;</span>
                               <span class="s">&quot; the server log</span><span class="si">%s</span><span class="s">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">via</span><span class="p">,</span> <span class="n">log</span><span class="p">))</span>

        <span class="n">proxy</span> <span class="o">=</span> <span class="n">mgr</span><span class="o">.</span><span class="n">openmdao_main_objserverfactory_ObjServerFactory</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">proxy</span><span class="o">.</span><span class="n">version</span> <span class="o">!=</span> <span class="n">__version__</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;Server version </span><span class="si">%r</span><span class="s"> different than local version </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span>
                            <span class="n">proxy</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">__version__</span><span class="p">)</span>
        <span class="n">_PROXIES</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">proxy</span>
        <span class="k">return</span> <span class="n">proxy</span>

</div>
<div class="viewcode-block" id="start_server"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.objserverfactory.start_server">[docs]</a><span class="k">def</span> <span class="nf">start_server</span><span class="p">(</span><span class="n">authkey</span><span class="o">=</span><span class="s">&#39;PublicKey&#39;</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&#39;server&#39;</span><span class="p">,</span>
                 <span class="n">allowed_hosts</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">allowed_users</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">allow_shell</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">allowed_types</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">tunnel</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">resources</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">log_prefix</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Start an :class:`ObjServerFactory` service in a separate process</span>
<span class="sd">    in the current directory.</span>

<span class="sd">    authkey: string</span>
<span class="sd">        Authorization key; must be matched by clients.</span>

<span class="sd">    address: string</span>
<span class="sd">        IPv4 address, hostname, or pipe name.</span>
<span class="sd">        Default is the host&#39;s default IPv4 address.</span>

<span class="sd">    port: int</span>
<span class="sd">        Server port (default of 0 implies next available port).</span>
<span class="sd">        Note that ports below 1024 typically require special privileges.</span>
<span class="sd">        If port is negative, then a local pipe is used for communication.</span>

<span class="sd">    prefix: string</span>
<span class="sd">        Prefix for server config file and stdout/stderr file.</span>

<span class="sd">    allowed_hosts: list(string)</span>
<span class="sd">        Host address patterns to check against. Required if `port` &gt;= 0.</span>
<span class="sd">        Ignored if `allowed_users` is specified.</span>

<span class="sd">    allowed_users: dict</span>
<span class="sd">        Dictionary of users and corresponding public keys allowed access.</span>
<span class="sd">        If None, *any* user may access. If empty, no user may access.</span>
<span class="sd">        The host portions of user strings are used for address patterns.</span>

<span class="sd">    allow_shell: bool</span>
<span class="sd">        If True, :meth:`execute_command` and :meth:`load_model` are allowed.</span>
<span class="sd">        Use with caution!</span>

<span class="sd">    allowed_types: list(string)</span>
<span class="sd">        Names of types which may be created. If None, then allow types listed</span>
<span class="sd">        by :meth:`get_available_types`. If empty, no types are allowed.</span>

<span class="sd">    timeout: int</span>
<span class="sd">        Seconds to wait for server to start. Note that public key generation</span>
<span class="sd">        can take a while. The default value of None will use an internally</span>
<span class="sd">        computed value based on host type (and for Windows, the availability</span>
<span class="sd">        of pyWin32).</span>

<span class="sd">    tunnel: bool</span>
<span class="sd">        If True, report host IP address but listen for connections from a</span>
<span class="sd">        local SSH tunnel.</span>

<span class="sd">    resources: string</span>
<span class="sd">        Filename for resource configuration.</span>

<span class="sd">    log_prefix: string</span>
<span class="sd">        Name used to identify remote remote logging messages from server.</span>
<span class="sd">        Implies that the local process will be receiving the messages.</span>

<span class="sd">    Returns ``(server_proc, config_filename)``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&#39;win32&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">HAVE_PYWIN32</span><span class="p">:</span>  <span class="c">#pragma no cover</span>
            <span class="n">timeout</span> <span class="o">=</span> <span class="mi">120</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">timeout</span> <span class="o">=</span> <span class="mi">30</span>

    <span class="n">server_key</span> <span class="o">=</span> <span class="n">prefix</span><span class="o">+</span><span class="s">&#39;.key&#39;</span>
    <span class="n">server_cfg</span> <span class="o">=</span> <span class="n">prefix</span><span class="o">+</span><span class="s">&#39;.cfg&#39;</span>
    <span class="n">server_out</span> <span class="o">=</span> <span class="n">prefix</span><span class="o">+</span><span class="s">&#39;.out&#39;</span>
    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="p">(</span><span class="n">server_cfg</span><span class="p">,</span> <span class="n">server_out</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">server_key</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out</span><span class="p">:</span>
        <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">authkey</span><span class="p">)</span>

    <span class="n">factory_path</span> <span class="o">=</span> <span class="n">pkg_resources</span><span class="o">.</span><span class="n">resource_filename</span><span class="p">(</span><span class="s">&#39;openmdao.main&#39;</span><span class="p">,</span>
                                                   <span class="s">&#39;objserverfactory.py&#39;</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;python&#39;</span><span class="p">,</span> <span class="n">factory_path</span><span class="p">,</span> <span class="s">&#39;--port&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">port</span><span class="p">),</span> <span class="s">&#39;--prefix&#39;</span><span class="p">,</span> <span class="n">prefix</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">address</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s">&#39;--address&#39;</span><span class="p">,</span> <span class="n">address</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">tunnel</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;--tunnel&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">resources</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;--resources&#39;</span><span class="p">)</span>
        <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resources</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">allowed_users</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">write_authorized_keys</span><span class="p">(</span><span class="n">allowed_users</span><span class="p">,</span> <span class="s">&#39;users.allow&#39;</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">())</span>
        <span class="n">args</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s">&#39;--users&#39;</span><span class="p">,</span> <span class="s">&#39;users.allow&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;--allow-public&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">port</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">allowed_hosts</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">allowed_hosts</span> <span class="o">=</span> <span class="p">[</span><span class="n">socket</span><span class="o">.</span><span class="n">gethostbyname</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">())]</span>
                <span class="k">if</span> <span class="n">allowed_hosts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;127.&#39;</span><span class="p">)</span> <span class="ow">and</span> \
                   <span class="s">&#39;127.0.0.1&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_hosts</span><span class="p">:</span>
                    <span class="n">allowed_hosts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;127.0.0.1&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;hosts.allow&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">allowed_hosts</span><span class="p">:</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">pattern</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">!=</span> <span class="s">&#39;win32&#39;</span> <span class="ow">or</span> <span class="n">HAVE_PYWIN32</span><span class="p">:</span>
                <span class="n">make_private</span><span class="p">(</span><span class="s">&#39;hosts.allow&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c">#pragma no cover</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Can&#39;t make hosts.allow private&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">allow_shell</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;--allow-shell&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">allowed_types</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;types.allow&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">typname</span> <span class="ow">in</span> <span class="n">allowed_types</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">typname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">!=</span> <span class="s">&#39;win32&#39;</span> <span class="ow">or</span> <span class="n">HAVE_PYWIN32</span><span class="p">:</span>
            <span class="n">make_private</span><span class="p">(</span><span class="s">&#39;types.allow&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c">#pragma no cover</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Can&#39;t make types.allow private&quot;</span><span class="p">)</span>
        <span class="n">args</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s">&#39;--types&#39;</span><span class="p">,</span> <span class="s">&#39;types.allow&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">log_prefix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">log_host</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>
        <span class="n">log_port</span> <span class="o">=</span> <span class="n">logging_port</span><span class="p">(</span><span class="n">log_host</span><span class="p">,</span> <span class="n">log_host</span><span class="p">)</span>
        <span class="n">args</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s">&#39;--log-host&#39;</span><span class="p">,</span> <span class="n">log_host</span><span class="p">,</span> <span class="s">&#39;--log-port&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">log_port</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">log_prefix</span><span class="p">:</span>  <span class="c"># Could be null (for default).</span>
            <span class="n">args</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s">&#39;--log-prefix&#39;</span><span class="p">,</span> <span class="n">log_prefix</span><span class="p">])</span>

    <span class="n">proc</span> <span class="o">=</span> <span class="n">ShellProc</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">server_out</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">STDOUT</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c"># Wait for valid server_cfg file.</span>
        <span class="n">retry</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">server_cfg</span><span class="p">))</span> <span class="ow">or</span> \
              <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">server_cfg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">return_code</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">return_code</span><span class="p">:</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">error_message</span><span class="p">(</span><span class="n">return_code</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;Server startup failed </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">error_msg</span><span class="p">)</span>
            <span class="n">retry</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">retry</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">*</span><span class="n">timeout</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="o">.</span><span class="mi">1</span><span class="p">)</span>
            <span class="c"># Hard to cause a startup timeout.</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c">#pragma no cover</span>
                <span class="n">proc</span><span class="o">.</span><span class="n">terminate</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;Server startup timeout&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">server_cfg</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">server_key</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">server_key</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="stop_server"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.objserverfactory.stop_server">[docs]</a><span class="k">def</span> <span class="nf">stop_server</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">config_filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Shutdown :class:`ObjServerFactory` specified by `config_filename` and</span>
<span class="sd">    terminate its process `server`.</span>

<span class="sd">    server: :class:`ShellProc`</span>
<span class="sd">        Server process returned by :meth:`start_server`.</span>

<span class="sd">    config_filename: string:</span>
<span class="sd">        Name of server configuration file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">factory</span> <span class="o">=</span> <span class="n">connect_to_server</span><span class="p">(</span><span class="n">config_filename</span><span class="p">)</span>
    <span class="n">factory</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
    <span class="n">server</span><span class="o">.</span><span class="n">terminate</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>


<span class="c"># Remote process code.</span>
</div>
<span class="n">_SERVER_CFG</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.objserverfactory.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>  <span class="c">#pragma no cover</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    OpenMDAO factory service process.</span>

<span class="sd">    Usage: python objserverfactory.py [--allow-public][--allow-shell][--hosts=filename][--types=filename][--users=filename][--address=address][--port=number][--prefix=name][--tunnel][--resources=filename][--log-host=hostname][--log-port=number][--log-prefix=string]</span>

<span class="sd">    --allow-public:</span>
<span class="sd">        Allows access by anyone from any allowed host. Use with care!</span>

<span class="sd">    --allow-shell:</span>
<span class="sd">        Allows access to :meth:`execute_command` and :meth:`load_model`.</span>
<span class="sd">        Use with care!</span>

<span class="sd">    --hosts: string</span>
<span class="sd">        Filename for allowed hosts specification. Default ``hosts.allow``.</span>
<span class="sd">        Ignored if &#39;--users&#39; is specified.</span>
<span class="sd">        The file should contain IPv4 host addresses, IPv4 domain addresses,</span>
<span class="sd">        or hostnames, one per line. Blank lines are ignored, and &#39;#&#39; marks the</span>
<span class="sd">        start of a comment which continues to the end of the line.</span>
<span class="sd">        For security reasons this file must be accessible only by the user</span>
<span class="sd">        running this server.</span>

<span class="sd">    --types: string</span>
<span class="sd">        Filename for allowed types specification.</span>
<span class="sd">        If not specified then allow types listed by</span>
<span class="sd">        :meth:`factorymanager.get_available_types`.</span>
<span class="sd">        The file should contain one type name per line.</span>

<span class="sd">    --users: string</span>
<span class="sd">        Filename for allowed users specification.</span>
<span class="sd">        Ignored if &#39;--allow-public&#39; is specified.</span>
<span class="sd">        Default is ``~/.ssh/authorized_keys``, other files should be of the</span>
<span class="sd">        same format: each line has ``key-type public-key-data user@host``,</span>
<span class="sd">        where `user` is the username on `host`. `host` will be translated to an</span>
<span class="sd">        IPv4 address and included in the allowed hosts list.</span>
<span class="sd">        Note that this ``user@host`` form is not necessarily enforced by</span>
<span class="sd">        programs which generate keys.</span>
<span class="sd">        For security reasons this file must be accessible only by the user</span>
<span class="sd">        running this server.</span>

<span class="sd">    --address: string</span>
<span class="sd">        IPv4 address, hostname, or pipe name.</span>
<span class="sd">        Default is the host&#39;s default IPv4 address.</span>

<span class="sd">    --port: int</span>
<span class="sd">        Server port (default of 0 implies next available port).</span>
<span class="sd">        Note that ports below 1024 typically require special privileges.</span>
<span class="sd">        If port is negative, then a local pipe is used for communication.</span>

<span class="sd">    --prefix: string</span>
<span class="sd">        Prefix for configuration and stdout/stderr files (default ``server``).</span>

<span class="sd">    --tunnel:</span>
<span class="sd">        Report host IP address but listen for connections from a local</span>
<span class="sd">        SSH tunnel.</span>

<span class="sd">    --resources: string</span>
<span class="sd">        Filename for resource configuration. If not specified then the</span>
<span class="sd">        default of ``~/.openmdao/resources.cfg`` will be used.</span>

<span class="sd">    --log-host: string</span>
<span class="sd">        Hostname to send remote log messages to.</span>

<span class="sd">    --log-port: int</span>
<span class="sd">        Port on `log-host` to send remote log messages to.</span>

<span class="sd">    --log-prefix: string</span>
<span class="sd">        Prefix to apply to remote log messages. Default is ``pid@host``.</span>

<span class="sd">    If ``prefix.key`` exists, it is read for an authorization key string.</span>
<span class="sd">    Otherwise, public key authorization and encryption is used.</span>

<span class="sd">    Allowed hosts *must* be specified if `port` is &gt;= 0. Only allowed hosts</span>
<span class="sd">    may connect to the server.</span>

<span class="sd">    Once initialized ``prefix.cfg`` is written with address, port, and</span>
<span class="sd">    public key information.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">optparse</span><span class="o">.</span><span class="n">OptionParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;--address&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&#39;str&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s">&#39;Network address to serve.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;--allow-public&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s">&#39;Allows access by any user, use with care!&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;--allow-shell&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s">&#39;Allows potential shell access, use with care!&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;--hosts&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&#39;str&#39;</span><span class="p">,</span>
                      <span class="n">default</span><span class="o">=</span><span class="s">&#39;hosts.allow&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&#39;Filename for allowed hosts&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;--types&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&#39;str&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s">&#39;Filename for allowed types&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;--users&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&#39;str&#39;</span><span class="p">,</span>
                      <span class="n">default</span><span class="o">=</span><span class="s">&#39;~/.ssh/authorized_keys&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s">&#39;Filename for allowed users&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;--port&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&#39;int&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s">&#39;Server port (0 implies next available port)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;--prefix&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">&#39;server&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s">&#39;Prefix for config and stdout/stderr files&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;--tunnel&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s">&#39;Report host IP address but listen for connections&#39;</span>
                           <span class="s">&#39; from a local SSH tunnel&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;--resources&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&#39;str&#39;</span><span class="p">,</span>
                      <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&#39;Filename for resource configuration&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;--log-host&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&#39;str&#39;</span><span class="p">,</span>
                      <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&#39;hostname for remote log messages&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;--log-port&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&#39;int&#39;</span><span class="p">,</span>
                      <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&#39;port for remote log messages&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;--log-prefix&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&#39;str&#39;</span><span class="p">,</span>
                      <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&#39;prefix for remote log messages&#39;</span><span class="p">)</span>

    <span class="n">options</span><span class="p">,</span> <span class="n">arguments</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">arguments</span><span class="p">:</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">print_help</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">log_host</span> <span class="ow">and</span> <span class="n">options</span><span class="o">.</span><span class="n">log_port</span><span class="p">:</span>
        <span class="n">install_remote_handler</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log_host</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log_port</span><span class="p">),</span>
                               <span class="n">options</span><span class="o">.</span><span class="n">log_prefix</span><span class="p">)</span>

    <span class="n">server_key</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">prefix</span><span class="o">+</span><span class="s">&#39;.key&#39;</span>
    <span class="n">server_cfg</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">prefix</span><span class="o">+</span><span class="s">&#39;.cfg&#39;</span>
    <span class="k">global</span> <span class="n">_SERVER_CFG</span>
    <span class="n">_SERVER_CFG</span> <span class="o">=</span> <span class="n">server_cfg</span>

    <span class="c"># Get authkey.</span>
    <span class="n">authkey</span> <span class="o">=</span> <span class="s">&#39;PublicKey&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">server_key</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">inp</span><span class="p">:</span>
            <span class="n">authkey</span> <span class="o">=</span> <span class="n">inp</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">server_key</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">allow_shell</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Shell access is ALLOWED&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">print</span> <span class="n">msg</span>

    <span class="n">allowed_users</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">allowed_hosts</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c"># Get allowed_users.</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">allow_public</span><span class="p">:</span>
        <span class="n">allowed_users</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Public access is ALLOWED&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">print</span> <span class="n">msg</span>

        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">port</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c"># Get allowed_hosts.</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">hosts</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">allowed_hosts</span> <span class="o">=</span> <span class="n">read_allowed_hosts</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">hosts</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Can&#39;t read allowed hosts file </span><span class="si">%r</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span> \
                          <span class="o">%</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">hosts</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">print</span> <span class="n">msg</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Allowed hosts file </span><span class="si">%r</span><span class="s"> does not exist.&#39;</span> <span class="o">%</span> <span class="n">options</span><span class="o">.</span><span class="n">hosts</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">print</span> <span class="n">msg</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">allowed_hosts</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;No hosts in allowed hosts file </span><span class="si">%r</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="n">options</span><span class="o">.</span><span class="n">hosts</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">print</span> <span class="n">msg</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">users</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">allowed_users</span> <span class="o">=</span> <span class="n">read_authorized_keys</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">users</span><span class="p">,</span> <span class="n">logger</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Can&#39;t read allowed users file </span><span class="si">%r</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span> \
                      <span class="o">%</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">users</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">print</span> <span class="n">msg</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Allowed users file </span><span class="si">%r</span><span class="s"> does not exist.&#39;</span> <span class="o">%</span> <span class="n">options</span><span class="o">.</span><span class="n">users</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">print</span> <span class="n">msg</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">allowed_users</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;No users in allowed users file </span><span class="si">%r</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="n">options</span><span class="o">.</span><span class="n">users</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">print</span> <span class="n">msg</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c"># Get allowed_types.</span>
    <span class="n">allowed_types</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">types</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">types</span><span class="p">):</span>
            <span class="n">allowed_types</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">types</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">inp</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">inp</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                <span class="k">while</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">line</span><span class="p">:</span>
                        <span class="n">allowed_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">inp</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Allowed types file </span><span class="si">%r</span><span class="s"> does not exist.&#39;</span> <span class="o">%</span> <span class="n">options</span><span class="o">.</span><span class="n">types</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">print</span> <span class="n">msg</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c"># Optionally configure resources.</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">resources</span><span class="p">:</span>
        <span class="c"># Import here to avoid import loop.</span>
        <span class="kn">from</span> <span class="nn">openmdao.main.resource</span> <span class="kn">import</span> <span class="n">ResourceAllocationManager</span> <span class="k">as</span> <span class="n">RAM</span>
        <span class="n">RAM</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">resources</span><span class="p">)</span>

    <span class="c"># Get address and create manager.</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">port</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">address</span><span class="p">:</span>  <span class="c"># Specify IPv4/hostname.</span>
            <span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="n">platform</span><span class="o">.</span><span class="n">node</span><span class="p">(),</span> <span class="n">options</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">address</span><span class="p">:</span>  <span class="c"># Specify pipename.</span>
            <span class="n">address</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">address</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">address</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Starting FactoryManager </span><span class="si">%s</span><span class="s"> </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">keytype</span><span class="p">(</span><span class="n">authkey</span><span class="p">))</span>
    <span class="n">current_process</span><span class="p">()</span><span class="o">.</span><span class="n">authkey</span> <span class="o">=</span> <span class="n">authkey</span>
    <span class="n">bind_address</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">port</span><span class="p">)</span> <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">tunnel</span> <span class="k">else</span> <span class="n">address</span>
    <span class="n">manager</span> <span class="o">=</span> <span class="n">_FactoryManager</span><span class="p">(</span><span class="n">bind_address</span><span class="p">,</span> <span class="n">authkey</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;Factory&#39;</span><span class="p">,</span>
                              <span class="n">allowed_hosts</span><span class="o">=</span><span class="n">allowed_hosts</span><span class="p">,</span>
                              <span class="n">allowed_users</span><span class="o">=</span><span class="n">allowed_users</span><span class="p">,</span>
                              <span class="n">allow_tunneling</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">tunnel</span><span class="p">)</span>

    <span class="c"># Set defaults for created ObjServerFactories.</span>
    <span class="c"># There isn&#39;t a good method to propagate these through the manager.</span>
    <span class="n">ObjServerFactory</span><span class="o">.</span><span class="n">_address</span> <span class="o">=</span> <span class="n">address</span>
    <span class="n">ObjServerFactory</span><span class="o">.</span><span class="n">_allow_shell</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">allow_shell</span>
    <span class="n">ObjServerFactory</span><span class="o">.</span><span class="n">_allowed_types</span> <span class="o">=</span> <span class="n">allowed_types</span>
    <span class="n">ObjServerFactory</span><span class="o">.</span><span class="n">_allow_tunneling</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">tunnel</span>

    <span class="c"># Get server, retry if specified address is in use.</span>
    <span class="n">server</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">retries</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">server</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">server</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">get_server</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;Address already in use&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">retries</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Address </span><span class="si">%s</span><span class="s"> in use, retrying...&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">address</span><span class="p">,)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">print</span> <span class="n">msg</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                    <span class="n">retries</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Address </span><span class="si">%s</span><span class="s"> in use, too many retries.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">address</span><span class="p">,)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">print</span> <span class="n">msg</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>

    <span class="c"># Record configuration.</span>
    <span class="n">real_ip</span> <span class="o">=</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">address</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">address</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">write_server_config</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">_SERVER_CFG</span><span class="p">,</span> <span class="n">real_ip</span><span class="p">)</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Serving on </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">server</span><span class="o">.</span><span class="n">address</span><span class="p">,)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">msg</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="c"># And away we go...</span>
    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="n">_sigterm_handler</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">_cleanup</span><span class="p">()</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

</div>
<span class="k">def</span> <span class="nf">_sigterm_handler</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>  <span class="c">#pragma no cover</span>
    <span class="sd">&quot;&quot;&quot; Try to go down gracefully. &quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;sigterm_handler invoked&#39;</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">&#39;sigterm_handler invoked&#39;</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="n">_cleanup</span><span class="p">()</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_cleanup</span><span class="p">():</span>  <span class="c">#pragma no cover</span>
    <span class="sd">&quot;&quot;&quot; Cleanup in preparation to shut down. &quot;&quot;&quot;</span>
    <span class="n">remove_remote_handlers</span><span class="p">()</span>
    <span class="n">keep_dirs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;OPENMDAO_KEEPDIRS&#39;</span><span class="p">,</span> <span class="s">&#39;0&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">keep_dirs</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">_SERVER_CFG</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">_SERVER_CFG</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>  <span class="c">#pragma no cover</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<a href="http://openmdao.org">
 <img src="../../../_static/OpenMDAO_Logo_200w_padded.png"
border="0" alt="OpenMDAO Home"/>
</a>

<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
  <li><a href="http://openmdao.org">OpenMDAO Home</a> &raquo;</li>
  
        <li><a href="../../../index.html">OpenMDAO Documentation v0.8.1</a> &raquo;</li>

          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright none.
      Last updated on Aug 26, 2013.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>