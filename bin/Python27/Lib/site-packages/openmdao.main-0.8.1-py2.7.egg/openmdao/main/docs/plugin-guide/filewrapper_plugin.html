
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Building a Plugin that Contains a File Wrapper &mdash; OpenMDAO Documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.8.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="OpenMDAO Documentation" href="../index.html" />
    <link rel="up" title="Plugin Developer Guide" href="index.html" />
    <link rel="next" title="Code Contribution Tutorial &amp; Checklist" href="../code-contribution-example.html" />
    <link rel="prev" title="Building a Plugin that Contains a Python Extension" href="extension_plugin.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../code-contribution-example.html" title="Code Contribution Tutorial &amp; Checklist"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="extension_plugin.html" title="Building a Plugin that Contains a Python Extension"
             accesskey="P">previous</a> |</li>
  <li><a href="http://openmdao.org">OpenMDAO Home</a> &raquo;</li>
  
        <li><a href="../index.html">OpenMDAO Documentation v0.8.1</a> &raquo;</li>

          <li><a href="index.html" accesskey="U">Plugin Developer Guide</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <span class="target" id="index-0"></span><div class="section" id="building-a-plugin-that-contains-a-file-wrapper">
<span id="building-a-plugin-using-a-file-wrapper"></span><span id="index-1"></span><h1>Building a Plugin that Contains a File Wrapper<a class="headerlink" href="#building-a-plugin-that-contains-a-file-wrapper" title="Permalink to this headline">¶</a></h1>
<p>For many legacy codes, the only viable way to include them in an MDAO process
is through file wrapping. In a file-wrapped component, the inputs are passed
and the outputs are extracted via input and output files. To
facilitate this process, OpenMDAO includes several utilities that will be
described in this section.</p>
<p>The execution of a file-wrapped component consists of the following three phases:</p>
<ul class="simple">
<li>Generating an input file that contains OpenMDAO variable values</li>
<li>Executing the external code</li>
<li>Parsing the output file and extracting values to place in OpenMDAO</li>
</ul>
<p>A file-wrapped component must perform all three of these tasks in its <tt class="docutils literal"><span class="pre">execute</span></tt>
function.</p>
<p>Presently, to create a file-wrapped component you must write some
Python code, so you need a basic knowledge of Python to proceed.</p>
<div class="section" id="a-note-on-precision">
<span id="index-2"></span><span id="id1"></span><h2>A Note on Precision<a class="headerlink" href="#a-note-on-precision" title="Permalink to this headline">¶</a></h2>
<p>In a file-wrapped component, all key inputs for the external code come from an intermediate file
that must be written. When generating the input file, it is important to prevent the loss of
precision. Consider a variable with 15 digits of precision.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">val</span> <span class="o">=</span> <span class="mf">3.1415926535897932</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">val</span>
<span class="go">3.141592653589793...</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">val</span>
<span class="go">3.14159265359</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
<span class="go">3.14159265359</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="s">&quot;</span><span class="si">%f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">val</span>
<span class="go">3.141593</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="s">&quot;</span><span class="si">%.16f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">val</span>
<span class="go">3.141592653589793...</span>
</pre></div>
</div>
<p>If the variable&#8217;s value in the input file is created using the <tt class="docutils literal"><span class="pre">print</span></tt>
statement, only 11 digits of precision are in the generated output. The same
is true if you convert the value to a string and use string output formatting.
Printing the variable as a floating point number with no format string gives
even less precision. To output the full precision of a variable, you must specify
decimal precision using formatted output (i.e., <tt class="docutils literal"><span class="pre">&quot;%.16f&quot;</span></tt>).</p>
<p>Quibbling over the 11th&#8211;15th decimal place may sound unnecessary,
but some applications are sensitive to changes of this magnitude. Moreover, it
is important to consider how your component may be used during optimization. A
gradient optimizer will often use a finite-difference scheme to calculate the
gradients for a model, and this means that some component inputs might be
subjected to small increments and decrements. A loss of precision here can
completely change the calculated gradient and prevent the optimizer from
reaching a correct minimum value.</p>
<p>The file-wrapping utilities in OpenMDAO use <tt class="docutils literal"><span class="pre">&quot;%.16g&quot;</span></tt>. If you write your own
custom input-file generator for a new component, you should use this format
for the floating point variables.</p>
<p>Precision is also important when parsing the output, although the file-parsing
utilities always grab the entire number. However, some codes limit the number of
digits of precision in their output files for human readability. In such a case,
you should check your external application&#8217;s manual to see if there is a flag for
telling the code to output the full precision.</p>
</div>
<div class="section" id="running-the-external-code">
<span id="index-3"></span><span id="id2"></span><h2>Running the External Code<a class="headerlink" href="#running-the-external-code" title="Permalink to this headline">¶</a></h2>
<p>The ExternalCode component takes care of the mundane tasks associated with
executing the external application. These include:</p>
<ul class="simple">
<li>Making the system call using the Subprocess module</li>
<li>Redirecting <cite>stdin, stdout,</cite> and <cite>stderr</cite> to the user&#8217;s specification</li>
<li>Capturing error codes</li>
<li>Defining environment variables</li>
<li>Handling timeout and polling</li>
<li>Running the code on a remote server if required</li>
</ul>
<p>So we recommend that you always derive your file-wrapped component from
the ExternalCode base class. The following example shows how to do this for a simple component.</p>
<p>Let&#8217;s consider a simple application called <cite>externalcode</cite>, which takes one
input and returns one output. The input is specified with an input file called
<tt class="docutils literal"><span class="pre">myinput.txt</span></tt>, and the output is printed in a file called <tt class="docutils literal"><span class="pre">myoutput.txt</span></tt>. The
name of the input file that externalcode expects is hard-coded and cannot be
changed. We want to create an OpenMDAO component that generates the input
file, runs the code, and reads the data from the output file every time the
component runs.</p>
<p>To do this, we create a component that looks like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">openmdao.lib.datatypes.api</span> <span class="kn">import</span> <span class="n">Float</span>
<span class="kn">from</span> <span class="nn">openmdao.lib.components.api</span> <span class="kn">import</span> <span class="n">ExternalCode</span>
<span class="kn">from</span> <span class="nn">openmdao.main.api</span> <span class="kn">import</span> <span class="n">FileMetadata</span>

<span class="c"># The following will be used for file wrapping, see the next sections</span>
<span class="kn">from</span> <span class="nn">openmdao.util.filewrap</span> <span class="kn">import</span> <span class="n">InputFileGenerator</span><span class="p">,</span> <span class="n">FileParser</span>

<span class="k">class</span> <span class="nc">WrappedComp</span><span class="p">(</span><span class="n">ExternalCode</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A simple file wrapper.&quot;&quot;&quot;</span>

    <span class="c"># Variables go here</span>
    <span class="n">var_input</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="mf">3.612</span><span class="p">,</span> <span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;A floating point input&#39;</span><span class="p">)</span>
    <span class="n">var_output</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="mf">6.312</span><span class="p">,</span> <span class="n">iotype</span><span class="o">=</span><span class="s">&#39;out&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;output&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructor for the PdcylComp component&quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">WrappedComp</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>

        <span class="c"># External Code public variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_file</span> <span class="o">=</span> <span class="s">&#39;myinput.txt&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_file</span> <span class="o">=</span> <span class="s">&#39;myoutput.txt&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="s">&#39;myerror.log&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">external_files</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">FileMetadata</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">input_file</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
            <span class="n">FileMetadata</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_file</span><span class="p">),</span>
            <span class="n">FileMetadata</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="p">),</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Executes our file-wrapped component. &quot;&quot;&quot;</span>

        <span class="c"># (Prepare input file here)</span>

        <span class="c"># Execute the component</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">WrappedComp</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

        <span class="c"># (Parse output file here)</span>
</pre></div>
</div>
<p>Instead of deriving our OpenMDAO component from <tt class="docutils literal"><span class="pre">component</span></tt>, we derive
it from <tt class="docutils literal"><span class="pre">ExternalCode</span></tt> to take advantage of the features listed above. Just
like in other components, we define variables for inputs and outputs.</p>
<p>In the <tt class="docutils literal"><span class="pre">__init__</span></tt> function, we can define the names of the input and output
files that the external code needs to run. Here we create two new private
variables <tt class="docutils literal"><span class="pre">self.input_file</span></tt> and <tt class="docutils literal"><span class="pre">self.output_file</span></tt> to store these filenames.
The name of these variables is not important. We also define a file for
redirection of <cite>stderr</cite>. The variable name <cite>stderr</cite> is inherited from the
ExternalCode component. Finally, the <tt class="docutils literal"><span class="pre">__init__</span></tt> function also contains a
block of code where these three files are added to the component&#8217;s
FileMetadata. This assures that when the model containing this component is
saved to an egg, these files are always packed up and included in that egg.
This is also necessary to support running the code on a remote server.</p>
<p>As with other components, the actual component execution occurs in the
<tt class="docutils literal"><span class="pre">execute</span></tt> method. Notice that the ExternalCode component takes care of
running the external code, so all we have to do is call the <tt class="docutils literal"><span class="pre">execute</span></tt>
method of our base class via the <em>Super</em> call. We would still need to generate
the input file and parse the output file. This example includes a placeholder
comment for each of these tasks. More detail about what goes there can be
found in the sections that follow.</p>
<p>To run, this component still needs one more piece of information &#8211;
the command string that runs the external code. The ExternalCode object has an
attribute named <cite>command</cite> which takes the command as a list of strings.
So, if you want to execute a code that you normally run by typing</p>
<div class="highlight-python"><pre>/usr/bin/externalcode -v -r1
/usr/bin/externalcode -v -r1</pre>
</div>
<p>at the command prompt, then you need to set the command attribute as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">MyComp</span> <span class="o">=</span> <span class="n">WrappedComp</span><span class="p">()</span>
<span class="n">MyComp</span><span class="o">.</span><span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;/usr/bin/externalcode&#39;</span><span class="p">,</span> <span class="s">&#39;-v&#39;</span><span class="p">,</span> <span class="s">&#39;-r1&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>Note that you could also declare this in the <tt class="docutils literal"><span class="pre">__init__</span></tt> method of <tt class="docutils literal"><span class="pre">WrappedComp</span></tt> if it
is something that you don&#8217;t expect the user will need to change. The same is true
of the other attributes described below.</p>
<p>This example is ready to execute, although it is missing the code that writes
out the input file and parses the output file. Subsequent sections explain how
to write these.</p>
<p>The ExternalCode object also allows you to specify <cite>stdout, stdin,</cite> and <cite>stderr</cite>.
For example, if your application handled input and output on the command line
using a redirection of <cite>stdout</cite> or <cite>stdin</cite> as such:</p>
<div class="highlight-python"><pre>/usr/bin/externalcode -v -r1 &lt; myinput.txt &gt; myoutput.txt</pre>
</div>
<p>you can let ExternalCode handle the redirection for you. When the following
attributes are set, the redirection is automatically appended to your command
line.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">MyComp</span><span class="o">.</span><span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;/usr/bin/externalcode&#39;</span><span class="p">,</span> <span class="s">&#39;-v&#39;</span><span class="p">,</span> <span class="s">&#39;-r1&#39;</span><span class="p">]</span>
<span class="n">MyComp</span><span class="o">.</span><span class="n">stdin</span> <span class="o">=</span> <span class="s">&#39;myinput.txt&#39;</span>
<span class="n">MyComp</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="s">&#39;myoutput.txt&#39;</span>
</pre></div>
</div>
<p>Note that you don&#8217;t just paste everything into the command string, particularly if you
want to assure cross-platform compatibility.</p>
<p>In the example, we captured the <cite>stderr</cite> output into a file called
<tt class="docutils literal"><span class="pre">myerror.log</span></tt>. If you would like to redirect <cite>stderr</cite> to <cite>stdout,</cite> you can
use the following:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">MyComp</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">MyComp</span><span class="o">.</span><span class="n">STDOUT</span>
</pre></div>
</div>
<p>Note the capital letters in <tt class="docutils literal"><span class="pre">STDOUT</span></tt>. We&#8217;ve saved the special symbol <tt class="docutils literal"><span class="pre">STDOUT</span></tt> that
is given in the subprocess module as a convenience.</p>
<p>Sometimes for code to execute you must set environment variables,
possibly to define paths that are needed to search for dynamic libraries, etc.
The ExternalCode allows you to define variables for the execution environment
using the dictionary <tt class="docutils literal"><span class="pre">env_vars</span></tt>.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">MyComp</span><span class="o">.</span><span class="n">env_vars</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;LIBRARY_PATH&#39;</span> <span class="p">:</span> <span class="s">&#39;/usr/local/lib&#39;</span> <span class="p">}</span>
</pre></div>
</div>
<p>The ExternalCode component also allows you to manage the polling rate and the
timeout values. <cite>Timeout</cite> is a measure of the maximum time to wait for the code to
complete its execution. If a component takes longer than the given timeout value,
then the process will end with a timeout error. Note that the default
timeout is 0, which means no timeout. The polling rate can also be adjusted
by setting the <tt class="docutils literal"><span class="pre">poll_delay</span></tt> attribute. Note that if it is not set, an internally
computed value is used (and this value will most likely be fine.)</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">MyComp</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">120</span>
<span class="n">MyComp</span><span class="o">.</span><span class="n">poll_delay</span> <span class="o">=</span> <span class="mi">10</span>
</pre></div>
</div>
<p>This capability proved useful in a recent case with an analysis code that
occasionally got caught in an infinite loop. A single execution of that code had
never exceeded 1 minute, so a 60-second timeout was used to terminate the execution
so that the inputs could be tweaked and tried again. The <tt class="docutils literal"><span class="pre">poll_delay</span></tt> attribute is
mainly useful for reducing the polling rate. There is no reason
to poll every second if the code normally takes hours to run.</p>
<p>Finally, if your code returns some kind of error or status code, you should
check it with this attribute.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">print</span> <span class="n">MyComp</span><span class="o">.</span><span class="n">return_code</span>
</pre></div>
</div>
</div>
<div class="section" id="generating-the-input-file-templated-file-i-o">
<span id="index-4"></span><h2>Generating the Input File - Templated File I/O<a class="headerlink" href="#generating-the-input-file-templated-file-i-o" title="Permalink to this headline">¶</a></h2>
<p>You can generate an input file for an external application two different ways. The
first way is to write the file completely from scratch using the new values that are
contained in the component&#8217;s variables. Not much can be done to aid with this task, as
it requires knowledge of the file format and can be completed using Python&#8217;s standard
formatted output. One exception to this is the Fortran namelist, which is more of a
standard output format. The next section mentions some tools to help create namelist
input files.</p>
<p id="index-5">The second way to generate an input file is by templating. A <em>template</em> file is
a sample input file which can be processed by a templating engine to insert
new values in the appropriate locations. Often the template file is a valid
input file before being processed, although other times it contains directives
or conditional logic to guide the generation. Obviously this method works well
for cases where only a small number of the possible variables and settings are
being manipulated by outside components.</p>
<p>OpenMDAO includes a basic templating capability that allows a template file to
be read, fields to be replaced with new values, and an input file to be
generated so that the external application can read it. Suppose you have an
input file that contains some integer, floating point, and string inputs:</p>
<div class="highlight-python"><pre>INPUT
1 2 3
INPUT
10.1 20.2 30.3
A B C</pre>
</div>
<p>This is a valid input file for your application, and it can also be used as a
template file. The templating object is called <cite>InputFileGenerator</cite>, and it
includes methods that can replace specific fields as measured by their row
and field numbers.</p>
<p>To use the InputFileGenerator object, first instantiate it and give it the name of
the template file and the name of the output file that you want to produce. (Note
that this code must be placed in the <tt class="docutils literal"><span class="pre">execute</span></tt> method of your component
<em>before</em> the external code is run. See <a class="reference internal" href="#running-the-external-code"><em>Running the External Code</em></a>.) The
code will generally look like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">openmdao.util.filewrap</span> <span class="kn">import</span> <span class="n">InputFileGenerator</span>

<span class="n">parser</span> <span class="o">=</span> <span class="n">InputFileGenerator</span><span class="p">()</span>
<span class="n">parser</span><span class="o">.</span><span class="n">set_template_file</span><span class="p">(</span><span class="s">&#39;mytemplate.txt&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">set_generated_file</span><span class="p">(</span><span class="s">&#39;myinput.txt&#39;</span><span class="p">)</span>

<span class="c"># (Call functions to poke new values here)</span>

<span class="n">parser</span><span class="o">.</span><span class="n">generate</span><span class="p">()</span>
</pre></div>
</div>
<p>When the template file is set, it is read into memory so that all subsequent
replacements are done without writing the intermediate file to the disk. Once
all replacements have been made, the <tt class="docutils literal"><span class="pre">generate</span></tt> method is called to create the
input file.</p>
<p>Let&#8217;s say you want to grab and replace the second integer with a 7. The code
would look like this.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">parser</span><span class="o">.</span><span class="n">mark_anchor</span><span class="p">(</span><span class="s">&quot;INPUT&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">transfer_var</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none"><div class="highlight"><pre>INPUT
1 7 3
INPUT
10.1 20.2 30.3
A B C
</pre></div>
</div>
<p id="index-6">The method <tt class="docutils literal"><span class="pre">mark_anchor</span></tt> is used to define an anchor, which becomes the
starting point for the <tt class="docutils literal"><span class="pre">transfer_var</span></tt> method. Here you find the second field in
the first line down from the anchor and replace it with the new value.</p>
<p>Now, what if you want to replace the third value of the floating point numbers
after the second <tt class="docutils literal"><span class="pre">INPUT</span></tt> statement. An additional argument can be passed to the
<tt class="docutils literal"><span class="pre">mark_anchor</span></tt> method to tell it to start at the second instance of the text
fragment <tt class="docutils literal"><span class="pre">&quot;INPUT&quot;</span></tt>.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">parser</span><span class="o">.</span><span class="n">reset_anchor</span><span class="p">()</span>
<span class="n">parser</span><span class="o">.</span><span class="n">mark_anchor</span><span class="p">(</span><span class="s">&quot;INPUT&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">my_var</span> <span class="o">=</span> <span class="mf">3.1415926535897932</span>
<span class="n">parser</span><span class="o">.</span><span class="n">transfer_var</span><span class="p">(</span><span class="n">my_var</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none"><div class="highlight"><pre>INPUT
1 7 3
INPUT
10.1 20.2 3.141592653589793
A B C
</pre></div>
</div>
<p>Note that you are able to pass a floating point value to <tt class="docutils literal"><span class="pre">transfer_var</span></tt> and still
keep 15 digits of precision. See <a class="reference internal" href="#a-note-on-precision"><em>A Note on Precision</em></a> for a discussion of
why this is important.</p>
<p>Note also that we used the method <tt class="docutils literal"><span class="pre">reset_anchor</span></tt> to return the anchor to the
beginning of the file before marking our new anchor. Subsequent calls to
<tt class="docutils literal"><span class="pre">mark_anchor</span></tt> start at the previous anchor and find the next instance of the
anchor text. It is a good practice to reset your anchor unless you are looking for
an instance of &#8220;B&#8221; that follows an instance of &#8220;A&#8221;.</p>
<p>You can also count backwards from the bottom of the file by passing a negative
number. Here, the second instance of <tt class="docutils literal"><span class="pre">&quot;INPUT&quot;</span></tt> from the bottom brings you
back to the first one.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">parser</span><span class="o">.</span><span class="n">reset_anchor</span><span class="p">()</span>
<span class="n">parser</span><span class="o">.</span><span class="n">mark_anchor</span><span class="p">(</span><span class="s">&quot;INPUT&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">transfer_var</span><span class="p">(</span><span class="s">&quot;99999&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none"><div class="highlight"><pre>INPUT
99999 7 3
INPUT
10.1 20.2 3.141592653589793
A B C
</pre></div>
</div>
<p>There is also a method for replacing an entire array of values. Try
replacing the set of three integers as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">array</span>

<span class="n">array_val</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="mi">123</span><span class="p">,</span> <span class="mi">456</span><span class="p">,</span> <span class="mi">789</span><span class="p">])</span>

<span class="n">parser</span><span class="o">.</span><span class="n">reset_anchor</span><span class="p">()</span>
<span class="n">parser</span><span class="o">.</span><span class="n">mark_anchor</span><span class="p">(</span><span class="s">&quot;INPUT&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">transfer_array</span><span class="p">(</span><span class="n">array_val</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none"><div class="highlight"><pre>INPUT
123 456 789
INPUT
10.1 20.2 3.141592653589793
A B C
</pre></div>
</div>
<p id="index-7">The method <tt class="docutils literal"><span class="pre">transfer_array</span></tt> takes four required inputs. The first is an array
of values that will become the new values in the file. The second is the
starting row after the anchor. The third is the starting field that will be
replaced, and the fourth is the ending field. The new array replaces the
block of fields spanned by the starting field and the ending field.</p>
<p>You can also use the <tt class="docutils literal"><span class="pre">transfer_array</span></tt> method to <cite>stretch</cite> an existing
array in a template to add more terms.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">array</span>

<span class="n">array_val</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="mi">11</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">66</span><span class="p">])</span>

<span class="n">parser</span><span class="o">.</span><span class="n">reset_anchor</span><span class="p">()</span>
<span class="n">parser</span><span class="o">.</span><span class="n">mark_anchor</span><span class="p">(</span><span class="s">&quot;INPUT&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">transfer_array</span><span class="p">(</span><span class="n">array_val</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">&#39; &#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none"><div class="highlight"><pre>INPUT
11 22 33 44 55 66
INPUT
10.1 20.2 3.141592653589793
A B C
</pre></div>
</div>
<p>The named argument <tt class="docutils literal"><span class="pre">sep</span></tt> defines which separator to include between the
additional terms of the array. Future revisions of InputFileGenerator will
hopefully be able to detect this automatically.</p>
<p>The input file templating capability that comes with OpenMDAO is basic but quite
functional. If you need a more powerful templating engine, particularly one that
allows the inclusion of logic in your template files, then you may want to consider
one of the community-developed engines, such as <a class="reference external" href="http://www.makotemplates.org/">mako</a> or <a class="reference external" href="https://docs.djangoproject.com/en/dev/topics/templates/">django</a>.</p>
<div class="admonition-todo admonition" id="index-8">
<p class="first admonition-title">Todo</p>
<p class="last">Include some examples with one of the templating engines.</p>
</div>
</div>
<div class="section" id="generating-the-input-file-fortran-namelists">
<span id="index-9"></span><h2>Generating the Input File - Fortran Namelists<a class="headerlink" href="#generating-the-input-file-fortran-namelists" title="Permalink to this headline">¶</a></h2>
<p>Since legacy Fortran codes are expected to be frequent candidates for
file wrapping, OpenMDAO includes a library for reading and generating Fortran
namelist. The syntax for a namelist varies somewhat depending on the
Fortran implementation, but the format generally looks like this:</p>
<div class="highlight-python"><pre>NAMEIn
! Comment string
&amp;GROUP1
 XREAL =  1.0e33,
 XINT = 2,
 XCHAR = 'namelist',
 XBOOL = T/
&amp;GROUP2
 AREAL =  1.  1.  2.  3.,
 AINT = 2 2 3 4,
 ACHAR = 'aaa' 'bbb' 'ccc' ' ddd',
 ABOOL = T T F F/</pre>
</div>
<p>The namelist utility includes methods to generate a valid namelist file from a
component&#8217;s set of input variables. Other methods can parse a
namelist file and load the variable data back into an OpenMDAO component&#8217;s
variables (which can be useful for populating a component with new values).</p>
<p>For example, consider a component whose inputs include five variables of
various types. A component that writes out an input file as a single
namelist called <cite>MAIN</cite> would look like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">array</span>

<span class="kn">from</span> <span class="nn">openmdao.lib.datatypes.api</span> <span class="kn">import</span> <span class="n">Float</span><span class="p">,</span> <span class="n">Int</span><span class="p">,</span> <span class="n">Str</span><span class="p">,</span> <span class="n">Bool</span><span class="p">,</span> <span class="n">Array</span>
<span class="kn">from</span> <span class="nn">openmdao.lib.components.api</span> <span class="kn">import</span> <span class="n">ExternalCode</span>

<span class="kn">from</span> <span class="nn">openmdao.util.namelist_util</span> <span class="kn">import</span> <span class="n">Namelist</span>

<span class="k">class</span> <span class="nc">WrappedComp</span><span class="p">(</span><span class="n">ExternalCode</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A simple file wrapper.&quot;&quot;&quot;</span>

    <span class="n">xreal</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="mf">35.6</span><span class="p">,</span> <span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;A floating point input&#39;</span><span class="p">)</span>
    <span class="n">xint</span> <span class="o">=</span> <span class="n">Int</span><span class="p">(</span><span class="mi">88</span><span class="p">,</span> <span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;An integer input&#39;</span><span class="p">)</span>
    <span class="n">xchar</span> <span class="o">=</span> <span class="n">Str</span><span class="p">(</span><span class="s">&quot;Hello&quot;</span><span class="p">,</span> <span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;A string input&#39;</span><span class="p">)</span>
    <span class="n">xbool</span> <span class="o">=</span> <span class="n">Bool</span><span class="p">(</span><span class="s">&quot;True&quot;</span><span class="p">,</span> <span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;A boolean input&#39;</span><span class="p">)</span>
    <span class="n">areal</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">]),</span> <span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;An array input&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Executes our file-wrapped component. &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stdin</span> <span class="o">=</span> <span class="s">&quot;FileWrapTemplate.txt&quot;</span>
        <span class="n">sb</span> <span class="o">=</span> <span class="n">Namelist</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">sb</span><span class="o">.</span><span class="n">set_filename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdin</span><span class="p">)</span>

        <span class="c"># Add a Title Card</span>
        <span class="n">sb</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">&quot;My Title&quot;</span><span class="p">)</span>

        <span class="c"># Add a group. Subsequent variables are in this group</span>
        <span class="n">sb</span><span class="o">.</span><span class="n">add_group</span><span class="p">(</span><span class="s">&#39;main&#39;</span><span class="p">)</span>

        <span class="c"># Toss in a comment</span>
        <span class="n">sb</span><span class="o">.</span><span class="n">add_comment</span><span class="p">(</span><span class="s">&#39; ! Comment goes here&#39;</span><span class="p">)</span>

        <span class="c"># Add all the variables</span>
        <span class="n">sb</span><span class="o">.</span><span class="n">add_var</span><span class="p">(</span><span class="s">&quot;xreal&quot;</span><span class="p">)</span>
        <span class="n">sb</span><span class="o">.</span><span class="n">add_var</span><span class="p">(</span><span class="s">&quot;xint&quot;</span><span class="p">)</span>
        <span class="n">sb</span><span class="o">.</span><span class="n">add_var</span><span class="p">(</span><span class="s">&quot;xchar&quot;</span><span class="p">)</span>
        <span class="n">sb</span><span class="o">.</span><span class="n">add_var</span><span class="p">(</span><span class="s">&quot;xbool&quot;</span><span class="p">)</span>
        <span class="n">sb</span><span class="o">.</span><span class="n">add_var</span><span class="p">(</span><span class="s">&quot;areal&quot;</span><span class="p">)</span>

        <span class="c"># Add an internal variable</span>
        <span class="n">sb</span><span class="o">.</span><span class="n">add_newvar</span><span class="p">(</span><span class="s">&quot;Py&quot;</span><span class="p">,</span> <span class="mf">3.14</span><span class="p">)</span>

        <span class="c"># Generate the input file for FLOPS</span>
        <span class="n">sb</span><span class="o">.</span><span class="n">generate</span><span class="p">()</span>
</pre></div>
</div>
<p>Note that this component is derived from <tt class="docutils literal"><span class="pre">ExternalCode</span></tt> and uses a few of its
features, so it is important to read <a class="reference internal" href="#running-the-external-code"><em>Running the External Code</em></a> before
proceeding.</p>
<p>In the <tt class="docutils literal"><span class="pre">execute</span></tt> method, a Namelist object is instantiated. This object
allows you to sequentially build up a namelist input file. The only argument
is <cite>self</cite>, which is passed because the Namelist object needs to access your
component&#8217;s OpenMDAO variables to automatically determine the data
type. The <tt class="docutils literal"><span class="pre">set_filename</span></tt> method is used to set the name of the input file that
will be written. Here, you just pass it the variable <tt class="docutils literal"><span class="pre">self.stdin</span></tt>, which is part
of the ExternalCode API.</p>
<p>The first card you create for the <tt class="docutils literal"><span class="pre">Namelist</span></tt> is the title card, which is
optionally assigned with the <tt class="docutils literal"><span class="pre">set_title</span></tt> method. After this, the first
namelist group is declared with the <tt class="docutils literal"><span class="pre">add_group</span></tt> method. Subsequent variables
are added to this namelist grouping. If <tt class="docutils literal"><span class="pre">add_group</span></tt> is called again, the
current group is closed, and any further variables are added to the new one.</p>
<p>The <tt class="docutils literal"><span class="pre">add_var</span></tt> method is used to add a variable to the <tt class="docutils literal"><span class="pre">Namelist</span></tt>. The only
needed argument is the variable&#8217;s name in the component. The variable&#8217;s type
is used to determine what kind of namelist variable to output. If you need to
add something to the namelist that isn&#8217;t contained in one of the component&#8217;s
variables, then use the <tt class="docutils literal"><span class="pre">add_newvar</span></tt> method, giving it a name and a value as
arguments. This method is what you will use if your variable has a different
name in your component than in the namelist file (i.e., you may have decided
to use a more descriptive name in Openmdao instead of the original cryptic
6-character Fortran name.)</p>
<p>Another method, <tt class="docutils literal"><span class="pre">add_comment</span></tt>, lets you add a comment to the
namelist. Of course, this isn&#8217;t an essential function, but there are times you
may want to add comments to enhance readability. The comment text should
include the comment character. Note that the namelist format doesn&#8217;t require a
comment character, but it&#8217;s still a good practice.</p>
<p>Finally, once every variable, group, and comment have been assigned, use the
<tt class="docutils literal"><span class="pre">generate</span></tt> method to create the input file. If a variable was entered
incorrectly, or if you have given it a variable type that it doesn&#8217;t know how
to handle (e.g., an Instance or a custom variable), an exception will be
raised. Otherwise, the input file is created, and your <tt class="docutils literal"><span class="pre">execute</span></tt> method can
move on to running your code.</p>
<div class="section" id="parsing-a-namelist-file">
<h3><em>Parsing a Namelist File</em><a class="headerlink" href="#parsing-a-namelist-file" title="Permalink to this headline">¶</a></h3>
<p>The Namelist object also includes some functions for parsing a namelist file and
loading the variable values into a component&#8217;s list of variables. Doing this
can be useful for loading in models that were developed when your code was executed
standalone.</p>
<div class="admonition-todo admonition" id="index-10">
<p class="first admonition-title">Todo</p>
<p class="last">Write about the namelist parsing functions.</p>
</div>
</div>
</div>
<div class="section" id="parsing-the-output-file">
<span id="index-11"></span><h2>Parsing the Output File<a class="headerlink" href="#parsing-the-output-file" title="Permalink to this headline">¶</a></h2>
<p>When an external code is executed, it typically outputs the results into a
file. OpenMDAO includes a few things to ease the task of extracting the
important information from a file.</p>
<div class="section" id="basic-extraction">
<h3><em>Basic Extraction</em><a class="headerlink" href="#basic-extraction" title="Permalink to this headline">¶</a></h3>
<p>Consider an application that produces the following as part of its
text-file output:</p>
<div class="highlight-python"><pre>LOAD CASE 1
STRESS 1.3334e7 3.9342e7 NaN 2.654e5
DISPLACEMENT 2.1 4.6 3.1 2.22234
LOAD CASE 2
STRESS 11 22 33 44 55 66
DISPLACEMENT 1.0 2.0 3.0 4.0 5.0</pre>
</div>
<p>As part of the file wrap, you need to reach into this file and grab the information
that is needed by downstream components in the model. OpenMDAO includes an
object called <cite>FileParser</cite>, which contains functions for parsing a file, grabbing
the fields you specify, and applying them to the appropriate data type. For this to
work, the file must have some general format that would allow you to locate the
piece of data you need relative to some constant feature in the file. In other
words, the main capability of the FileParser is to locate and extract a set of
characters that is some number of lines and some number of fields away from an
<cite>anchor</cite> point.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">openmdao.util.filewrap</span> <span class="kn">import</span> <span class="n">FileParser</span>

<span class="n">parser</span> <span class="o">=</span> <span class="n">FileParser</span><span class="p">()</span>
<span class="n">parser</span><span class="o">.</span><span class="n">set_file</span><span class="p">(</span><span class="s">&#39;myoutput.txt&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>To use the FileParser object, first instantiate it and give it the name of the
output file. (Note that this code must be placed in your component&#8217;s
<tt class="docutils literal"><span class="pre">execute</span></tt> function <em>after</em> the external code has been run. See
<a class="reference internal" href="#running-the-external-code"><em>Running the External Code</em></a>.)</p>
<p>Say you want to grab the first <tt class="docutils literal"><span class="pre">STRESS</span></tt> value from each load case in the file
snippet shown above. The code would look like this. (Note: in this example the print
statement is there only for display.)</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">parser</span><span class="o">.</span><span class="n">mark_anchor</span><span class="p">(</span><span class="s">&quot;LOAD CASE&quot;</span><span class="p">)</span>
<span class="n">var</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">transfer_var</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="k">print</span> <span class="s">&quot;</span><span class="si">%g</span><span class="s"> is a </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>
<span class="bp">self</span><span class="o">.</span><span class="n">xreal</span> <span class="o">=</span> <span class="n">var</span>
</pre></div>
</div>
<div class="highlight-none"><div class="highlight"><pre>1.3334e+07 is a &lt;type &#39;float&#39;&gt;
</pre></div>
</div>
<p>The method <tt class="docutils literal"><span class="pre">mark_anchor</span></tt> is used to define an anchor, which becomes the
starting point for the <tt class="docutils literal"><span class="pre">transfer_var</span></tt> method. Here, you grab the value from the
second field in the first line down from the anchor. The parser is smart enough to
recognize the number as floating point and to create a Python float variable.
The final statement assigns this value to the component variable <cite>xreal</cite>.</p>
<p>The third value of <tt class="docutils literal"><span class="pre">STRESS</span></tt> is <cite>NaN</cite>. If you want to grab that element, you can type
this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">parser</span><span class="o">.</span><span class="n">reset_anchor</span><span class="p">()</span>
<span class="n">parser</span><span class="o">.</span><span class="n">mark_anchor</span><span class="p">(</span><span class="s">&quot;LOAD CASE&quot;</span><span class="p">)</span>
<span class="n">var</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">transfer_var</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

<span class="k">print</span> <span class="s">&quot;</span><span class="si">%g</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">var</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="n">nan</span>
</pre></div>
</div>
<p>Python also has built-in values for <cite>nan</cite> and <cite>inf</cite> that are valid for float variables. The parser
recognizes them when it encounters them in a file. This allows you to catch numerical overflows,
underflows, etc., and take action. NumPy includes the functions <tt class="docutils literal"><span class="pre">isnan</span></tt> and <tt class="docutils literal"><span class="pre">isinf</span></tt> to test for
<cite>nan</cite> and <cite>inf</cite> respectively.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">isnan</span><span class="p">,</span> <span class="n">isinf</span>

<span class="k">print</span> <span class="n">isnan</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="bp">True</span>
</pre></div>
</div>
<p>When the data is not a number, it is recognized as a string. Grab the
word <tt class="docutils literal"><span class="pre">DISPLACEMENT</span></tt>.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">parser</span><span class="o">.</span><span class="n">reset_anchor</span><span class="p">()</span>
<span class="n">parser</span><span class="o">.</span><span class="n">mark_anchor</span><span class="p">(</span><span class="s">&quot;LOAD CASE&quot;</span><span class="p">)</span>
<span class="n">var</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">transfer_var</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="k">print</span> <span class="n">var</span>
</pre></div>
</div>
<div class="highlight-none"><div class="highlight"><pre>DISPLACEMENT
</pre></div>
</div>
<p>Now, what if you want to grab the value of stress from the second load case? An
additional argument can be passed to the <tt class="docutils literal"><span class="pre">mark_anchor</span></tt> method telling it to
start at the second instance of the text fragment <tt class="docutils literal"><span class="pre">&quot;LOAD</span> <span class="pre">CASE&quot;</span></tt>.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">parser</span><span class="o">.</span><span class="n">reset_anchor</span><span class="p">()</span>
<span class="n">parser</span><span class="o">.</span><span class="n">mark_anchor</span><span class="p">(</span><span class="s">&quot;LOAD CASE&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">var</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">transfer_var</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="k">print</span> <span class="n">var</span>
</pre></div>
</div>
<div class="highlight-none"><div class="highlight"><pre>11
</pre></div>
</div>
<p>Note also that we used the method <tt class="docutils literal"><span class="pre">reset_anchor</span></tt> to return the anchor to the
beginning of the file before marking our new anchor. Subsequent calls to
<tt class="docutils literal"><span class="pre">mark_anchor</span></tt> start at the previous anchor and find the next instance of the
anchor text. It is a good practice to reset your anchor unless you are looking for
an instance of &#8220;B&#8221; that follows an instance of &#8220;A&#8221;.</p>
<p>You can also count backwards from the bottom of the file by passing a negative
number. Here, the second instance of <tt class="docutils literal"><span class="pre">&quot;LOAD</span> <span class="pre">CASE&quot;</span></tt> from the bottom brings us
back to the first one.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">parser</span><span class="o">.</span><span class="n">reset_anchor</span><span class="p">()</span>
<span class="n">parser</span><span class="o">.</span><span class="n">mark_anchor</span><span class="p">(</span><span class="s">&quot;LOAD CASE&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
<span class="n">var</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">transfer_var</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="k">print</span> <span class="s">&quot;</span><span class="si">%g</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">var</span>
</pre></div>
</div>
<div class="highlight-none"><div class="highlight"><pre>1.3334e+07
</pre></div>
</div>
<p>There is a shortcut for extracting data that is stored as <tt class="docutils literal"><span class="pre">Key</span> <span class="pre">Value</span></tt> or
<tt class="docutils literal"><span class="pre">&quot;Key</span> <span class="pre">Value</span> <span class="pre">Value....</span></tt>.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">parser</span><span class="o">.</span><span class="n">reset_anchor</span><span class="p">()</span>
<span class="n">parser</span><span class="o">.</span><span class="n">mark_anchor</span><span class="p">(</span><span class="s">&quot;LOAD CASE 1&quot;</span><span class="p">)</span>
<span class="n">var</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">transfer_keyvar</span><span class="p">(</span><span class="s">&quot;DISPLACEMENT&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="k">print</span> <span class="s">&quot;</span><span class="si">%g</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">var</span>
</pre></div>
</div>
<div class="highlight-none"><div class="highlight"><pre>2.1
</pre></div>
</div>
<p>The method <tt class="docutils literal"><span class="pre">transfer_keyvar</span></tt> finds the first occurrence of the <em>key</em> string
after the anchor (in this case, the word <tt class="docutils literal"><span class="pre">DISPLACEMENT</span></tt>), and grabs the
specified field value. This can be useful in cases where variables are found
on lines that are uniquely named, particularly where you don&#8217;t always know how
many lines the key will occur past the anchor location. There are two optional
arguments to <tt class="docutils literal"><span class="pre">transfer_keyvar</span></tt>. The first lets you specify the <cite>nth</cite> occurrence
of the key, and the second lets you specify a number of lines to offset from
the line where the key is found (negative numbers are allowed).</p>
</div>
<div class="section" id="array-extraction">
<h3><em>Array Extraction</em><a class="headerlink" href="#array-extraction" title="Permalink to this headline">¶</a></h3>
<p>Now consider the same application that produces the following as part of its
text-file output:</p>
<div class="highlight-python"><pre>LOAD CASE 1
STRESS 1.3334e7 3.9342e7 NaN 2.654e5
DISPLACEMENT 2.1 4.6 3.1 2.22234
LOAD CASE 2
STRESS 11 22 33 44 55 66
DISPLACEMENT 1.0 2.0 3.0 4.0 5.0</pre>
</div>
<p>This time, grab all of the displacements in one read and store
them as an array. You can do this with the <tt class="docutils literal"><span class="pre">transfer_array</span></tt> method.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">parser</span><span class="o">.</span><span class="n">reset_anchor</span><span class="p">()</span>
<span class="n">parser</span><span class="o">.</span><span class="n">mark_anchor</span><span class="p">(</span><span class="s">&quot;LOAD CASE&quot;</span><span class="p">)</span>
<span class="n">var</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">transfer_array</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

<span class="k">print</span> <span class="n">var</span>
</pre></div>
</div>
<div class="highlight-none"><div class="highlight"><pre>[ 2.1      4.6      3.1      2.22234]
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">transfer_array</span></tt> method takes four arguments: <em>starting row, starting field,
ending row,</em> and <em>ending field.</em> The parser extracts all values from the starting
row and field and continues until it hits the ending field in the ending row.
These values are all placed in a 1D array. When extracting multiple lines, if
a line break is hit, the parser continues reading from the next line until the
last line is hit. The following extraction illustrates this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">parser</span><span class="o">.</span><span class="n">reset_anchor</span><span class="p">()</span>
<span class="n">parser</span><span class="o">.</span><span class="n">mark_anchor</span><span class="p">(</span><span class="s">&quot;LOAD CASE&quot;</span><span class="p">)</span>
<span class="n">var</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">transfer_array</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

<span class="k">print</span> <span class="n">var</span>
</pre></div>
</div>
<div class="highlight-none"><div class="highlight"><pre>[&#39;39342000.0&#39; &#39;nan&#39; &#39;265400.0&#39; &#39;DISPLACEMENT&#39; &#39;2.1&#39; &#39;4.6&#39; &#39;3.1&#39;]
</pre></div>
</div>
<p>With the inclusion of <tt class="docutils literal"><span class="pre">'DISPLACEMENT'</span></tt>, this is returned as an array of strings,
so you must be careful.</p>
<p>There is also a method to extract a 2-dimensional array from tabulated data.
Consider an output table that looks like this:</p>
<div class="highlight-python"><pre>FREQ  DELTA   A     B     C     D     E     F     G     H     I     J
 Hz
 50.   1.0   30.0  34.8  36.3  36.1  34.6  32.0  28.4  23.9  18.5  12.2
 63.   1.0   36.5  41.3  42.8  42.6  41.1  38.5  34.9  30.4  25.0  18.7
 80.   1.0   42.8  47.6  49.1  48.9  47.4  44.8  41.2  36.7  31.3  25.0
100.   1.0   48.4  53.1  54.7  54.5  53.0  50.4  46.8  42.3  36.9  30.6</pre>
</div>
<p>We would like to extract the relevant numerical data from this table, which
amounts to all values contained in columns labeled &#8220;A&#8221; through &#8220;J&#8221; and rows
labeled &#8220;50 Hz&#8221; through &#8220;100 Hz.&#8221; We would like to save these values in a
two-dimensional numpy array. This can be accomplished using the <tt class="docutils literal"><span class="pre">transfer_2Darray</span></tt>
method.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">parser</span><span class="o">.</span><span class="n">reset_anchor</span><span class="p">()</span>
<span class="n">parser</span><span class="o">.</span><span class="n">mark_anchor</span><span class="p">(</span><span class="s">&quot;Hz&quot;</span><span class="p">)</span>
<span class="n">var</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">transfer_2Darray</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>

<span class="k">print</span> <span class="n">var</span>
</pre></div>
</div>
<div class="highlight-none"><div class="highlight"><pre>[[ 30.   34.8  36.3  36.1  34.6  32.   28.4  23.9  18.5  12.2]
 [ 36.5  41.3  42.8  42.6  41.1  38.5  34.9  30.4  25.   18.7]
 [ 42.8  47.6  49.1  48.9  47.4  44.8  41.2  36.7  31.3  25. ]
 [ 48.4  53.1  54.7  54.5  53.   50.4  46.8  42.3  36.9  30.6]]
</pre></div>
</div>
<p>The arguments to <tt class="docutils literal"><span class="pre">transfer_2Darray</span></tt> are the starting row number, the starting field
number, the ending row number, and the ending field number. If the end field is
omitted, then all values to the end of the line are extracted. In that case, care
must be taken to make sure that all lines have the same number of values.</p>
<p>Note that if the delimiter is set to <tt class="docutils literal"><span class="pre">'columns'</span></tt>, then the column number should be
entered instead of the field number. Delimiters are discussed in the next section.</p>
</div>
<div class="section" id="delimiters">
<span id="index-12"></span><h3><em>Delimiters</em><a class="headerlink" href="#delimiters" title="Permalink to this headline">¶</a></h3>
<p>When the parser counts fields in a line of output, it determines the field
boundaries by comparing against a set of delimiters. These delimiters can be
changed using the <tt class="docutils literal"><span class="pre">set_delimiters</span></tt> method. By default, the delimiters are the
general white space characters space (<tt class="docutils literal"><span class="pre">&quot;</span> <span class="pre">&quot;</span></tt>) and tab (<tt class="docutils literal"><span class="pre">&quot;\\t&quot;</span></tt>). The newline characters
(<tt class="docutils literal"><span class="pre">&quot;\\n&quot;</span></tt> and <tt class="docutils literal"><span class="pre">&quot;\\r&quot;</span></tt>) are always removed regardless of the delimiter status.</p>
<p>One common case that will require a change in the default delimiter is the comma
separated file (i.e, csv). Here&#8217;s an example of such an output file:</p>
<div class="highlight-python"><pre>CASE 1
3,7,2,4,5,6</pre>
</div>
<p>Try grabbing the first element without changing the delimiters:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">parser</span><span class="o">.</span><span class="n">mark_anchor</span><span class="p">(</span><span class="s">&quot;CASE&quot;</span><span class="p">)</span>
<span class="n">var</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">transfer_var</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="k">print</span> <span class="n">var</span>
</pre></div>
</div>
<div class="highlight-none"><div class="highlight"><pre>,7,2,4,5,6
</pre></div>
</div>
<p>What happened here is slightly confusing, but the main point is that the parser
did not handle this as expected because commas were not in the set of
delimiters. Now specify commas as your delimiter.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">parser</span><span class="o">.</span><span class="n">reset_anchor</span><span class="p">()</span>
<span class="n">parser</span><span class="o">.</span><span class="n">mark_anchor</span><span class="p">(</span><span class="s">&quot;CASE&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">set_delimiters</span><span class="p">(</span><span class="s">&quot;, &quot;</span><span class="p">)</span>
<span class="n">var</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">transfer_var</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="k">print</span> <span class="n">var</span>
</pre></div>
</div>
<div class="highlight-none"><div class="highlight"><pre>7
</pre></div>
</div>
<p>With the correct delimiter set, you extract the second integer as expected.</p>
<p>While the ability to set the delimiters adds flexibility for parsing many
different types of input files, you may find cases that are too complex to
parse (e.g., a field with separator characters inside of quotes.) In such cases
you may need to read and extract the data manually.</p>
</div>
<div class="section" id="special-case-delimiter-columns">
<h3><em>Special Case Delimiter - Columns</em><a class="headerlink" href="#special-case-delimiter-columns" title="Permalink to this headline">¶</a></h3>
<p>One special-case value of the delimiter, <tt class="docutils literal"><span class="pre">'columns'</span></tt>, is useful when the
data fields have defined column location, as is the case in certain formatted
output from Fortran or C. When the delimiter is set to <tt class="docutils literal"><span class="pre">'columns'</span></tt>, the
behavior of some of the methods is slightly different. Consider the following
output file:</p>
<div class="highlight-python"><pre>CASE 1
12345678901234567890
TTF    3.7-9.4434967</pre>
</div>
<p>The second line is a comment that helps the reader identify the column
number (particularly on a printout) and does not need to be parsed.</p>
<p>In the third line, the first three columns contain flags that are either <tt class="docutils literal"><span class="pre">'T'</span></tt>
or <tt class="docutils literal"><span class="pre">'F'</span></tt>. Columns 4-10 contain a floating point number, and columns 11
through 20 contain another floating point number. Note that there isn&#8217;t
always a space between the two numbers in this format, particularly when the
second number has a negative sign. We can&#8217;t parse this with a regular
separator, but we can use the special separator <tt class="docutils literal"><span class="pre">'columns'</span></tt>.</p>
<p>Let&#8217;s parse this file to extract the third boolean flag and the two numbers.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">parser</span><span class="o">.</span><span class="n">reset_anchor</span><span class="p">()</span>
<span class="n">parser</span><span class="o">.</span><span class="n">mark_anchor</span><span class="p">(</span><span class="s">&quot;CASE&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">set_delimiters</span><span class="p">(</span><span class="s">&quot;columns&quot;</span><span class="p">)</span>
<span class="n">var1</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">transfer_var</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">var2</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">transfer_var</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">var3</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">transfer_var</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>

<span class="k">print</span> <span class="n">var1</span>
<span class="k">print</span> <span class="n">var2</span>
<span class="k">print</span> <span class="n">var3</span>
</pre></div>
</div>
<p>When the delimiters are in column mode, <tt class="docutils literal"><span class="pre">transfer_var</span></tt> takes the starting
field and the ending field as its second and third arguments. Since we just
want one column for the boolean flag, the starting field and ending field are
the same. This gives us the output:</p>
<div class="highlight-none"><div class="highlight"><pre>F
3.7
-9.4434967
</pre></div>
</div>
<p>which is what we wanted to extract.</p>
<p>The <tt class="docutils literal"><span class="pre">transfer_array</span></tt> method can also be used with columns, but it is used
differently than <tt class="docutils literal"><span class="pre">transfer_var</span></tt>. Consider this output file:</p>
<div class="highlight-python"><pre>CASE 2
123456789012345678901234567890
NODE 11 22 33 COMMENT
NODE 44 55 66 STUFF</pre>
</div>
<p>In this example, we want to extract the six numerical values and place them in
an array. When the delimiter is set to columns, we can define a rectangular
box from which all elements are parsed into an array. Note that the numbers
inside of the box are parsed assuming standard separator characters (<tt class="docutils literal"><span class="pre">&quot;</span> <span class="pre">\t&quot;</span></tt>).</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">parser</span><span class="o">.</span><span class="n">reset_anchor</span><span class="p">()</span>
<span class="n">parser</span><span class="o">.</span><span class="n">mark_anchor</span><span class="p">(</span><span class="s">&quot;CASE 2&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">set_delimiters</span><span class="p">(</span><span class="s">&quot;columns&quot;</span><span class="p">)</span>
<span class="n">var</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">transfer_array</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">13</span><span class="p">)</span>

<span class="k">print</span> <span class="n">var</span>
</pre></div>
</div>
<p>So here we&#8217;ve called <tt class="docutils literal"><span class="pre">transfer_array</span></tt> with four arguments: <cite>starting row,
starting column, ending row, ending column</cite>. This results in the following
value for var:</p>
<div class="highlight-none"><div class="highlight"><pre>[ 11.  22.  33.  44.  55.  66.]
</pre></div>
</div>
<p>You can always exit column mode and return to normal delimiter parsing by setting the
delimiters back to the default:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">parser</span><span class="o">.</span><span class="n">set_delimiters</span><span class="p">(</span><span class="s">&quot; </span><span class="se">\t</span><span class="s">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<a href="http://openmdao.org">
 <img src="../_static/OpenMDAO_Logo_200w_padded.png"
border="0" alt="OpenMDAO Home"/>
</a>

  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Building a Plugin that Contains a File Wrapper</a><ul>
<li><a class="reference internal" href="#a-note-on-precision">A Note on Precision</a></li>
<li><a class="reference internal" href="#running-the-external-code">Running the External Code</a></li>
<li><a class="reference internal" href="#generating-the-input-file-templated-file-i-o">Generating the Input File - Templated File I/O</a></li>
<li><a class="reference internal" href="#generating-the-input-file-fortran-namelists">Generating the Input File - Fortran Namelists</a><ul>
<li><a class="reference internal" href="#parsing-a-namelist-file"><em>Parsing a Namelist File</em></a></li>
</ul>
</li>
<li><a class="reference internal" href="#parsing-the-output-file">Parsing the Output File</a><ul>
<li><a class="reference internal" href="#basic-extraction"><em>Basic Extraction</em></a></li>
<li><a class="reference internal" href="#array-extraction"><em>Array Extraction</em></a></li>
<li><a class="reference internal" href="#delimiters"><em>Delimiters</em></a></li>
<li><a class="reference internal" href="#special-case-delimiter-columns"><em>Special Case Delimiter - Columns</em></a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="extension_plugin.html"
                        title="previous chapter">Building a Plugin that Contains a Python Extension</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../code-contribution-example.html"
                        title="next chapter">Code Contribution Tutorial &amp; Checklist</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/plugin-guide/filewrapper_plugin.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../code-contribution-example.html" title="Code Contribution Tutorial &amp; Checklist"
             >next</a> |</li>
        <li class="right" >
          <a href="extension_plugin.html" title="Building a Plugin that Contains a Python Extension"
             >previous</a> |</li>
  <li><a href="http://openmdao.org">OpenMDAO Home</a> &raquo;</li>
  
        <li><a href="../index.html">OpenMDAO Documentation v0.8.1</a> &raquo;</li>

          <li><a href="index.html" >Plugin Developer Guide</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright none.
      Last updated on Aug 26, 2013.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>